# recognition.py
# –£–º–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∞ –ø–æ:
# - —Ñ–∞–º–∏–ª–∏–∏/–∏–º–µ–Ω–∏ –∞–≤—Ç–æ—Ä–∞
# - –Ω–∞–∑–≤–∞–Ω–∏—é –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
# - –≥–µ—Ä–æ—é (–ø–µ—Ä—Å–æ–Ω–∞–∂—É)
#
# –ë–µ–∑ "—Ä–∏—Å–∫–æ–≤": –º—ã –ù–ï –≤—ã–±–∏—Ä–∞–µ–º –∞–≤—Ç–æ—Ä–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º 1‚Äì3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –∫–Ω–æ–ø–∫–∞–º–∏.
# –ö–∞–Ω–¥–∏–¥–∞—Ç—ã —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –ø–æ list_author_keys(), —á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –∞–≤—Ç–æ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ authors.py

import re
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.types import InlineKeyboardButton

from authors import get_author, list_author_keys


def _norm(s: str) -> str:
    s = (s or "").lower().replace("—ë", "–µ")
    s = re.sub(r"[¬´¬ª\"'`]", " ", s)
    s = re.sub(r"[^a-z–∞-—è0-9\s\-]", " ", s)
    s = re.sub(r"\s+", " ", s).strip()
    return s


def _contains_phrase(text_norm: str, phrase_norm: str) -> bool:
    if not phrase_norm:
        return False
    pattern = r"(?:^|\s)" + re.escape(phrase_norm) + r"(?:$|\s)"
    return re.search(pattern, text_norm) is not None or phrase_norm in text_norm


# --- 1) –ê–≤—Ç–æ—Ä –ø–æ —Ñ–∞–º–∏–ª–∏–∏/–∏–º–µ–Ω–∏ (—Å–∞–º–æ–µ –Ω–∞–¥—ë–∂–Ω–æ–µ) ---
AUTHOR_NAME_HINTS = {
    # –ö–ª—é—á–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å authors.py (–µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –æ–Ω–∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
    "–ø—É—à–∫–∏–Ω": "pushkin",
    "–∞–ª–µ–∫—Å–∞–Ω–¥—Ä –ø—É—à–∫–∏–Ω": "pushkin",

    "–ª–µ—Ä–º–æ–Ω—Ç–æ–≤": "lermontov",
    "–≥–æ–≥–æ–ª—å": "gogol",
    "–¥–æ—Å—Ç–æ–µ–≤—Å–∫": "dostoevsky",
    "—Ç–æ–ª—Å—Ç–æ–π": "tolstoy",
    "–ª–µ–≤ —Ç–æ–ª—Å—Ç–æ–π": "tolstoy",
    "—á–µ—Ö–æ–≤": "chekhov",

    "–∞—Ö–º–∞—Ç–æ–≤": "akhmatova",
    "–±–ª–æ–∫": "blok",
    "–µ—Å–µ–Ω–∏–Ω": "yesenin",
    "–º–∞—è–∫–æ–≤—Å–∫": "mayakovsky",

    "–±—É–ª–≥–∞–∫–æ–≤": "bulgakov",
    "—à–æ–ª–æ—Ö–æ–≤": "sholokhov",
    "–±—Ä–æ–¥—Å–∫": "brodsky",
    "—Ñ–∏–ª–∞—Ç–æ–≤": "filatov",
    "–ø–µ–ª–µ–≤–∏–Ω": "pelevin",
}


# --- 2) –ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ -> –∞–≤—Ç–æ—Ä ---
# –ú–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å —Ö–æ—Ç—å –¥–æ 500 ‚Äî –∞–ª–≥–æ—Ä–∏—Ç–º –≤—ã–¥–µ—Ä–∂–∏—Ç.
WORK_TO_AUTHOR = {
    # –ü–£–®–ö–ò–ù
    "–∫–∞–ø–∏—Ç–∞–Ω—Å–∫–∞—è –¥–æ—á–∫–∞": "pushkin",
    "–µ–≤–≥–µ–Ω–∏–π –æ–Ω–µ–≥–∏–Ω": "pushkin",
    "–ø–∏–∫–æ–≤–∞—è –¥–∞–º–∞": "pushkin",
    "–¥—É–±—Ä–æ–≤—Å–∫–∏–π": "pushkin",
    "–±–æ—Ä–∏—Å –≥–æ–¥—É–Ω–æ–≤": "pushkin",
    "–ø–æ–≤–µ—Å—Ç–∏ –±–µ–ª–∫–∏–Ω–∞": "pushkin",
    "–≤—ã—Å—Ç—Ä–µ–ª": "pushkin",
    "–º–µ—Ç–µ–ª—å": "pushkin",
    "–≥—Ä–æ–±–æ–≤—â–∏–∫": "pushkin",
    "—Å—Ç–∞–Ω—Ü–∏–æ–Ω–Ω—ã–π —Å–º–æ—Ç—Ä–∏—Ç–µ–ª—å": "pushkin",
    "–±–∞—Ä—ã—à–Ω—è –∫—Ä–µ—Å—Ç—å—è–Ω–∫–∞": "pushkin",
    "–º–µ–¥–Ω—ã–π –≤—Å–∞–¥–Ω–∏–∫": "pushkin",
    "—Ä—É—Å–ª–∞–Ω –∏ –ª—é–¥–º–∏–ª–∞": "pushkin",
    "—Å–∫–∞–∑–∫–∞ –æ —Ä—ã–±–∞–∫–µ –∏ —Ä—ã–±–∫–µ": "pushkin",
    "—Å–∫–∞–∑–∫–∞ –æ —Ü–∞—Ä–µ —Å–∞–ª—Ç–∞–Ω–µ": "pushkin",
    "—Å–∫–∞–∑–∫–∞ –æ –º–µ—Ä—Ç–≤–æ–π —Ü–∞—Ä–µ–≤–Ω–µ –∏ —Å–µ–º–∏ –±–æ–≥–∞—Ç—ã—Ä—è—Ö": "pushkin",

    # –õ–ï–†–ú–û–ù–¢–û–í
    "–≥–µ—Ä–æ–π –Ω–∞—à–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏": "lermontov",
    "–º—Ü—ã—Ä–∏": "lermontov",
    "–¥–µ–º–æ–Ω": "lermontov",
    "–ø–∞—Ä—É—Å": "lermontov",
    "–±–æ—Ä–æ–¥–∏–Ω–æ": "lermontov",

    # –ì–û–ì–û–õ–¨
    "–º–µ—Ä—Ç–≤—ã–µ –¥—É—à–∏": "gogol",
    "—Ä–µ–≤–∏–∑–æ—Ä": "gogol",
    "—à–∏–Ω–µ–ª—å": "gogol",
    "–Ω–æ—Å": "gogol",
    "–≤–∏–π": "gogol",
    "—Ç–∞—Ä–∞—Å –±—É–ª—å–±–∞": "gogol",
    "–≤–µ—á–µ—Ä–∞ –Ω–∞ —Ö—É—Ç–æ—Ä–µ –±–ª–∏–∑ –¥–∏–∫–∞–Ω—å–∫–∏": "gogol",
    "—Å–æ—Ä–æ—á–∏–Ω—Å–∫–∞—è —è—Ä–º–∞—Ä–∫–∞": "gogol",
    "–Ω–æ—á—å –ø–µ—Ä–µ–¥ —Ä–æ–∂–¥–µ—Å—Ç–≤–æ–º": "gogol",

    # –î–û–°–¢–û–ï–í–°–ö–ò–ô
    "–ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –∏ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ": "dostoevsky",
    "–±—Ä–∞—Ç—å—è –∫–∞—Ä–∞–º–∞–∑–æ–≤—ã": "dostoevsky",
    "–∏–¥–∏–æ—Ç": "dostoevsky",
    "–±–µ—Å—ã": "dostoevsky",
    "—É–Ω–∏–∂–µ–Ω–Ω—ã–µ –∏ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–Ω—ã–µ": "dostoevsky",
    "–∑–∞–ø–∏—Å–∫–∏ –∏–∑ –ø–æ–¥–ø–æ–ª—å—è": "dostoevsky",

    # –¢–û–õ–°–¢–û–ô
    "–≤–æ–π–Ω–∞ –∏ –º–∏—Ä": "tolstoy",
    "–∞–Ω–Ω–∞ –∫–∞—Ä–µ–Ω–∏–Ω–∞": "tolstoy",
    "–≤–æ—Å–∫—Ä–µ—Å–µ–Ω–∏–µ": "tolstoy",
    "–¥–µ—Ç—Å—Ç–≤–æ": "tolstoy",
    "–æ—Ç—Ä–æ—á–µ—Å—Ç–≤–æ": "tolstoy",
    "—é–Ω–æ—Å—Ç—å": "tolstoy",
    "–ø–æ—Å–ª–µ –±–∞–ª–∞": "tolstoy",
    "–∫–∞–≤–∫–∞–∑—Å–∫–∏–π –ø–ª–µ–Ω–Ω–∏–∫": "tolstoy",
    "—Ö–æ–ª—Å—Ç–æ–º–µ—Ä": "tolstoy",

    # –ß–ï–•–û–í
    "–≤–∏—à–Ω–µ–≤—ã–π —Å–∞–¥": "chekhov",
    "–≤–∏—à–Ω—ë–≤—ã–π —Å–∞–¥": "chekhov",
    "—Ç—Ä–∏ —Å–µ—Å—Ç—Ä—ã": "chekhov",
    "–ø–∞–ª–∞—Ç–∞ 6": "chekhov",
    "–ø–∞–ª–∞—Ç–∞ ‚Ññ6": "chekhov",
    "—á–µ–ª–æ–≤–µ–∫ –≤ —Ñ—É—Ç–ª—è—Ä–µ": "chekhov",
    "—Ö–∞–º–µ–ª–µ–æ–Ω": "chekhov",
    "—Ç–æ–ª—Å—Ç—ã–π –∏ —Ç–æ–Ω–∫–∏–π": "chekhov",
    "–¥–∞–º–∞ —Å —Å–æ–±–∞—á–∫–æ–π": "chekhov",
    "–∏–æ–Ω—ã—á": "chekhov",

    # –°–ï–†–ï–ë–†–Ø–ù–´–ô –í–ï–ö
    "—Ä–µ–∫–≤–∏–µ–º": "akhmatova",
    "–ø–æ—ç–º–∞ –±–µ–∑ –≥–µ—Ä–æ—è": "akhmatova",
    "–¥–≤–µ–Ω–∞–¥—Ü–∞—Ç—å": "blok",
    "–Ω–µ–∑–Ω–∞–∫–æ–º–∫–∞": "blok",
    "–∏—Å–ø–æ–≤–µ–¥—å —Ö—É–ª–∏–≥–∞–Ω–∞": "yesenin",
    "–ø–µ—Ä—Å–∏–¥—Å–∫–∏–µ –º–æ—Ç–∏–≤—ã": "yesenin",
    "–æ–±–ª–∞–∫–æ –≤ —à—Ç–∞–Ω–∞—Ö": "mayakovsky",
    "—Ñ–ª–µ–π—Ç–∞ –ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫": "mayakovsky",
    "—Ñ–ª–µ–π—Ç–∞-–ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫": "mayakovsky",

    # –ë–£–õ–ì–ê–ö–û–í
    "–º–∞—Å—Ç–µ—Ä –∏ –º–∞—Ä–≥–∞—Ä–∏—Ç–∞": "bulgakov",
    "—Å–æ–±–∞—á—å–µ —Å–µ—Ä–¥—Ü–µ": "bulgakov",
    "–±–µ–ª–∞—è –≥–≤–∞—Ä–¥–∏—è": "bulgakov",
    "–º–æ—Ä—Ñ–∏–π": "bulgakov",

    # –®–û–õ–û–•–û–í
    "—Ç–∏—Ö–∏–π –¥–æ–Ω": "sholokhov",
    "—Å—É–¥—å–±–∞ —á–µ–ª–æ–≤–µ–∫–∞": "sholokhov",

    # –§–ò–õ–ê–¢–û–í
    "–ø—Ä–æ —Ñ–µ–¥–æ—Ç–∞ —Å—Ç—Ä–µ–ª—å—Ü–∞": "filatov",
    "–ø—Ä–æ —Ñ–µ–¥–æ—Ç–∞ —Å—Ç—Ä–µ–ª—å—Ü–∞ —É–¥–∞–ª–æ–≥–æ –º–æ–ª–æ–¥—Ü–∞": "filatov",

    # –ü–ï–õ–ï–í–ò–ù (—á–∞—Å—Ç–æ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç)
    "generation –ø": "pelevin",
    "generation ¬´–ø¬ª": "pelevin",
    "generation p": "pelevin",
    "—á–∞–ø–∞–µ–≤ –∏ –ø—É—Å—Ç–æ—Ç–∞": "pelevin",
}

# --- 3) –ì–µ—Ä–æ–π -> –∞–≤—Ç–æ—Ä ---
# –¢–æ–ª—å–∫–æ "—Å–∏–≥–Ω–∞—Ç—É—Ä–Ω—ã–µ" –≥–µ—Ä–æ–∏: —á—Ç–æ–±—ã –Ω–µ –ª–æ–≤–∏—Ç—å —Å–ª—É—á–∞–π–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è.
HERO_TO_AUTHOR = {
    # –ü—É—à–∫–∏–Ω
    "–≥—Ä–∏–Ω–µ–≤": "pushkin",
    "–≥—Ä–∏–Ω—ë–≤": "pushkin",
    "–ø—É–≥–∞—á–µ–≤": "pushkin",
    "–ø—É–≥–∞—á—ë–≤": "pushkin",
    "–º–∞—à–∞ –º–∏—Ä–æ–Ω–æ–≤–∞": "pushkin",
    "—à–≤–∞–±—Ä–∏–Ω": "pushkin",
    "–æ–Ω–µ–≥–∏–Ω": "pushkin",
    "–ª–µ–Ω—Å–∫–∏–π": "pushkin",
    "—Ç–∞—Ç—å—è–Ω–∞ –ª–∞—Ä–∏–Ω–∞": "pushkin",
    "–≥–µ—Ä–º–∞–Ω–Ω": "pushkin",

    # –õ–µ—Ä–º–æ–Ω—Ç–æ–≤
    "–ø–µ—á–æ—Ä–∏–Ω": "lermontov",
    "–º–∞–∫—Å–∏–º –º–∞–∫—Å–∏–º—ã—á": "lermontov",
    "–±—ç–ª–∞": "lermontov",

    # –ì–æ–≥–æ–ª—å
    "—á–∏—á–∏–∫–æ–≤": "gogol",
    "–º–∞–Ω–∏–ª–æ–≤": "gogol",
    "—Å–æ–±–∞–∫–µ–≤–∏—á": "gogol",
    "–ø–ª—é—à–∫–∏–Ω": "gogol",
    "—Ö–ª–µ—Å—Ç–∞–∫–æ–≤": "gogol",
    "–∞–∫–∞–∫–∏–π –∞–∫–∞–∫–∏–µ–≤–∏—á": "gogol",

    # –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π
    "—Ä–∞—Å–∫–æ–ª—å–Ω–∏–∫–æ–≤": "dostoevsky",
    "—Å–æ–Ω—è –º–∞—Ä–º–µ–ª–∞–¥–æ–≤–∞": "dostoevsky",
    "—Å–≤–∏–¥—Ä–∏–≥–∞–π–ª–æ–≤": "dostoevsky",
    "–ø–æ—Ä—Ñ–∏—Ä–∏–π –ø–µ—Ç—Ä–æ–≤–∏—á": "dostoevsky",
    "–∫–Ω—è–∑—å –º—ã—à–∫–∏–Ω": "dostoevsky",
    "–Ω–∞—Å—Ç—å—è —Ñ–∏–ª–∏–ø–ø–æ–≤–Ω–∞": "dostoevsky",

    # –¢–æ–ª—Å—Ç–æ–π
    "–ø—å–µ—Ä –±–µ–∑—É—Ö–æ–≤": "tolstoy",
    "–∞–Ω–¥—Ä–µ–π –±–æ–ª–∫–æ–Ω—Å–∫–∏–π": "tolstoy",
    "–Ω–∞—Ç–∞—à–∞ —Ä–æ—Å—Ç–æ–≤–∞": "tolstoy",
    "–∞–Ω–Ω–∞ –∫–∞—Ä–µ–Ω–∏–Ω–∞": "tolstoy",
    "–≤—Ä–æ–Ω—Å–∫–∏–π": "tolstoy",
    "–ª–µ–≤–∏–Ω": "tolstoy",

    # –ß–µ—Ö–æ–≤
    "–±–µ–ª–∏–∫–æ–≤": "chekhov",

    # –ë—É–ª–≥–∞–∫–æ–≤
    "–≤–æ–ª–∞–Ω–¥": "bulgakov",
    "–º–∞—Ä–≥–∞—Ä–∏—Ç–∞": "bulgakov",
    "—à–∞—Ä–∏–∫–æ–≤": "bulgakov",
    "–ø—Ä–µ–æ–±—Ä–∞–∂–µ–Ω—Å–∫–∏–π": "bulgakov",

    # –®–æ–ª–æ—Ö–æ–≤
    "–º–µ–ª–µ—Ö–æ–≤": "sholokhov",

    # –§–∏–ª–∞—Ç–æ–≤
    "—Ñ–µ–¥–æ—Ç": "filatov",
}

# –ö–æ—Ä–æ—Ç–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è ‚Äî —Ç–æ–ª—å–∫–æ —Ç–æ—á–Ω–æ–π —Ñ—Ä–∞–∑–æ–π
SHORT_TITLES_RISK = {"–∞—Å—è", "–Ω–æ—Å", "–≤–∏–π", "–ø–∞—Ä—É—Å", "–±–æ—Ä–æ–¥–∏–Ω–æ", "–º–æ—Ä—Ñ–∏–π", "–∏–æ–Ω—ã—á"}


def guess_authors_from_text(user_text: str, limit: int = 3):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤:
    [{"author_key": "...", "author_name": "...", "reason": "...", "score": int}]
    """
    text_norm = _norm(user_text)
    available = set(list_author_keys())

    scores = {}
    reasons = {}

    def add_score(akey: str, score: int, reason: str):
        if akey not in available:
            return
        prev = scores.get(akey, 0)
        if score > prev:
            scores[akey] = score
            reasons[akey] = reason

    # 1) —Ñ–∞–º–∏–ª–∏—è –∞–≤—Ç–æ—Ä–∞
    for hint, akey in AUTHOR_NAME_HINTS.items():
        h = _norm(hint)
        if h and _contains_phrase(text_norm, h):
            add_score(akey, 110, "—É–∑–Ω–∞–ª –∞–≤—Ç–æ—Ä–∞ –ø–æ —Ñ–∞–º–∏–ª–∏–∏/—É–ø–æ–º–∏–Ω–∞–Ω–∏—é")

    # 2) –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
    for title, akey in WORK_TO_AUTHOR.items():
        t = _norm(title)
        if not t:
            continue

        if t in SHORT_TITLES_RISK:
            if _contains_phrase(text_norm, t):
                add_score(akey, 85, "–ø–æ—Ö–æ–∂–µ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è (—Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)")
            continue

        if t in text_norm:
            score = 65 + min(len(t), 45)
            add_score(akey, score, "–ø–æ—Ö–æ–∂–µ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è")

    # 3) –≥–µ—Ä–æ–π
    for hero, akey in HERO_TO_AUTHOR.items():
        h = _norm(hero)
        if h and _contains_phrase(text_norm, h):
            add_score(akey, 95, "–ø–æ—Ö–æ–∂–µ –ø–æ –ø–µ—Ä—Å–æ–Ω–∞–∂—É –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è")

    res = []
    for akey, score in scores.items():
        res.append({
            "author_key": akey,
            "author_name": get_author(akey).get("name", akey),
            "reason": reasons.get(akey, "–ø–æ—Ö–æ–∂–µ –ø–æ —Å–º—ã—Å–ª—É"),
            "score": score
        })

    res.sort(key=lambda x: x["score"], reverse=True)
    return res[:max(1, limit)]


def build_quick_author_keyboard(candidates):
    kb = InlineKeyboardBuilder()
    for c in candidates:
        kb.row(
            InlineKeyboardButton(
                text=f"‚úÖ –û—Ç–≤–µ—Ç–∏—Ç—å –∫–∞–∫ {c['author_name']}",
                callback_data=f"quick_author_{c['author_key']}"
            )
        )
    kb.row(InlineKeyboardButton(text="üîÅ –í—ã–±—Ä–∞—Ç—å –∞–≤—Ç–æ—Ä–∞ –≤—Ä—É—á–Ω—É—é", callback_data="groups_menu"))
    kb.row(InlineKeyboardButton(text="üè† –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu"))
    return kb.as_markup()
