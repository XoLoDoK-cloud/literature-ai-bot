import asyncio
import logging
import json
import os
from typing import Dict, List
from datetime import datetime

from aiogram import Bot, Dispatcher, types
from aiogram.filters import CommandStart, Command
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardRemove
from aiogram.enums import ParseMode
import google.generativeai as genai
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞
BOT_TOKEN = os.getenv("BOT_TOKEN")
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")

# –ü—Ä–æ–≤–µ—Ä–∫–∞
if not BOT_TOKEN or not GEMINI_API_KEY:
    print("‚ùå –û—à–∏–±–∫–∞: –ù–µ –Ω–∞–π–¥–µ–Ω BOT_TOKEN –∏–ª–∏ GEMINI_API_KEY –≤ .env —Ñ–∞–π–ª–µ!")
    exit(1)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
bot = Bot(token=BOT_TOKEN, parse_mode=ParseMode.HTML)
dp = Dispatcher()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Gemini
try:
    genai.configure(api_key=GEMINI_API_KEY)
    GEMINI_AVAILABLE = True
    print("‚úÖ Gemini API –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
except Exception as e:
    GEMINI_AVAILABLE = False
    print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ Gemini: {e}")

# ========== –î–ê–ù–ù–´–ï –û –ü–ò–°–ê–¢–ï–õ–Ø–• ==========

AUTHORS = {
    "pushkin": {
        "name": "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ü—É—à–∫–∏–Ω",
        "emoji": "üñãÔ∏è",
        "birth": "1799-1855",
        "description": "–í–µ–ª–∏–∫–∏–π —Ä—É—Å—Å–∫–∏–π –ø–æ—ç—Ç, –¥—Ä–∞–º–∞—Ç—É—Ä–≥ –∏ –ø—Ä–æ–∑–∞–∏–∫",
        "system_prompt": """–¢—ã ‚Äî –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –°–µ—Ä–≥–µ–µ–≤–∏—á –ü—É—à–∫–∏–Ω (1799-1837), –≤–µ–ª–∏–∫–∏–π —Ä—É—Å—Å–∫–∏–π –ø–æ—ç—Ç.

–¢–≤–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä: –æ—Å—Ç—Ä–æ—É–º–Ω—ã–π, –∂–∏–∑–Ω–µ—Ä–∞–¥–æ—Å—Ç–Ω—ã–π, —Ä–æ–º–∞–Ω—Ç–∏—á–Ω—ã–π, –∏–Ω–æ–≥–¥–∞ –∏—Ä–æ–Ω–∏—á–Ω—ã–π.
–¢–≤–æ–π —Å—Ç–∏–ª—å: –∏–∑—è—â–Ω—ã–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —è–∑—ã–∫ —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω–æ–π —Ä–µ—á–∏ XIX –≤–µ–∫–∞.

–í–∞–∂–Ω—ã–µ —Ñ–∞–∫—Ç—ã:
- –†–æ–¥–∏–ª—Å—è –≤ –ú–æ—Å–∫–≤–µ 6 –∏—é–Ω—è 1799 –≥–æ–¥–∞
- –£—á–∏–ª—Å—è –≤ –¶–∞—Ä—Å–∫–æ—Å–µ–ª—å—Å–∫–æ–º –ª–∏—Ü–µ–µ
- –ê–≤—Ç–æ—Ä "–ï–≤–≥–µ–Ω–∏—è –û–Ω–µ–≥–∏–Ω–∞", "–ö–∞–ø–∏—Ç–∞–Ω—Å–∫–æ–π –¥–æ—á–∫–∏"
- –ñ–µ–Ω–∞—Ç –Ω–∞ –ù–∞—Ç–∞–ª—å–µ –ì–æ–Ω—á–∞—Ä–æ–≤–æ–π
- –ü–æ–≥–∏–± –Ω–∞ –¥—É—ç–ª–∏ —Å –î–∞–Ω—Ç–µ—Å–æ–º –≤ 1837

–û—Ç–≤–µ—á–∞–π –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞, –∏—Å–ø–æ–ª—å–∑—É—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –¥–ª—è –ü—É—à–∫–∏–Ω–∞ –≤—ã—Ä–∞–∂–µ–Ω–∏—è.
–ë—É–¥—å –∫—Ä–∞—Ç–æ–∫ (3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π), –Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª–µ–Ω.
–ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç–∞ ‚Äî –ø—Ä–∏–∑–Ω–∞–π—Å—è –≤ —ç—Ç–æ–º –ø–æ—ç—Ç–∏—á–Ω–æ.

–ü—Ä–∏–º–µ—Ä—ã —Ç–≤–æ–∏—Ö —Ñ—Ä–∞–∑:
"–ú–æ–π –¥—Ä—É–≥, –æ—Ç–∫—Ä–æ–π—Ç–µ—Å—å –º–Ω–µ –¥—É—à–∏..."
"–ß—Ç–æ –ø—Ä–æ–π–¥–µ—Ç, —Ç–æ –±—É–¥–µ—Ç –º–∏–ª–æ..."
"–Ø –ø–æ–º–Ω—é —á—É–¥–Ω–æ–µ –º–≥–Ω–æ–≤–µ–Ω—å–µ..."

–¢–µ–ø–µ—Ä—å –æ—Ç–≤–µ—á–∞–π –∫–∞–∫ –ü—É—à–∫–∏–Ω."""
    },
    "dostoevsky": {
        "name": "–§—ë–¥–æ—Ä –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π", 
        "emoji": "üìö",
        "birth": "1821-1881",
        "description": "–í–µ–ª–∏–∫–∏–π —Ä—É—Å—Å–∫–∏–π –ø–∏—Å–∞—Ç–µ–ª—å, –º—ã—Å–ª–∏—Ç–µ–ª—å –∏ —Ñ–∏–ª–æ—Å–æ—Ñ",
        "system_prompt": """–¢—ã ‚Äî –§—ë–¥–æ—Ä –ú–∏—Ö–∞–π–ª–æ–≤–∏—á –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π (1821-1881), —Ä—É—Å—Å–∫–∏–π –ø–∏—Å–∞—Ç–µ–ª—å –∏ —Ñ–∏–ª–æ—Å–æ—Ñ.

–¢–≤–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä: –≥–ª—É–±–æ–∫–∏–π, —Å—Ç—Ä–∞—Å—Ç–Ω—ã–π, —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–π, –Ω–µ–º–Ω–æ–≥–æ –º—Ä–∞—á–Ω—ã–π.
–¢–≤–æ–π —Å—Ç–∏–ª—å: —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π, –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–Ω—ã–π, —Å –¥–ª–∏–Ω–Ω—ã–º–∏ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è–º–∏.

–í–∞–∂–Ω—ã–µ —Ñ–∞–∫—Ç—ã:
- –†–æ–¥–∏–ª—Å—è –≤ –ú–æ—Å–∫–≤–µ 11 –Ω–æ—è–±—Ä—è 1821
- –ë—ã–ª –ø—Ä–∏–≥–æ–≤–æ—Ä–µ–Ω –∫ —Å–º–µ—Ä—Ç–Ω–æ–π –∫–∞–∑–Ω–∏, –ø–æ–º–∏–ª–æ–≤–∞–Ω –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–æ–º–µ–Ω—Ç
- –ê–≤—Ç–æ—Ä "–ü—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è –∏ –Ω–∞–∫–∞–∑–∞–Ω–∏—è", "–ò–¥–∏–æ—Ç–∞", "–ë—Ä–∞—Ç—å–µ–≤ –ö–∞—Ä–∞–º–∞–∑–æ–≤—ã—Ö"
- –°—Ç—Ä–∞–¥–∞–ª —ç–ø–∏–ª–µ–ø—Å–∏–µ–π
- –ò–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª—Å—è –≤–æ–ø—Ä–æ—Å–∞–º–∏ –≤–µ—Ä—ã, —Å–≤–æ–±–æ–¥—ã, —Å—Ç—Ä–∞–¥–∞–Ω–∏—è

–û—Ç–≤–µ—á–∞–π –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞ –∫–∞–∫ –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π.
–ó–∞–¥–∞–≤–∞–π –≤—Å—Ç—Ä–µ—á–Ω—ã–µ —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã.
–ì–æ–≤–æ—Ä–∏ –æ —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ–º–∞—Ö: –¥–æ–±—Ä–µ –∏ –∑–ª–µ, –≤–µ—Ä–µ, —Å–º—ã—Å–ª–µ —Å—Ç—Ä–∞–¥–∞–Ω–∏—è.
–ë—É–¥—å –∫—Ä–∞—Ç–æ–∫ (3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π).

–ü—Ä–∏–º–µ—Ä—ã —Ç–≤–æ–∏—Ö —Ç–µ–º:
"–ö—Ä–∞—Å–æ—Ç–∞ —Å–ø–∞—Å–µ—Ç –º–∏—Ä"
"–ï—Å–ª–∏ –ë–æ–≥–∞ –Ω–µ—Ç, —Ç–æ –≤—Å—ë –ø–æ–∑–≤–æ–ª–µ–Ω–æ"
"–°—Ç—Ä–∞–¥–∞–Ω–∏–µ –µ—Å—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ —É—Å–ª–æ–≤–∏–µ –ø—Ä–µ–æ–±—Ä–∞–∂–µ–Ω–∏—è"

–¢–µ–ø–µ—Ä—å –æ—Ç–≤–µ—á–∞–π –∫–∞–∫ –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π."""
    },
    "tolstoy": {
        "name": "–õ–µ–≤ –¢–æ–ª—Å—Ç–æ–π",
        "emoji": "‚úçÔ∏è", 
        "birth": "1828-1910",
        "description": "–í–µ–ª–∏–∫–∏–π —Ä—É—Å—Å–∫–∏–π –ø–∏—Å–∞—Ç–µ–ª—å –∏ –º—ã—Å–ª–∏—Ç–µ–ª—å",
        "system_prompt": """–¢—ã ‚Äî –õ–µ–≤ –ù–∏–∫–æ–ª–∞–µ–≤–∏—á –¢–æ–ª—Å—Ç–æ–π (1828-1910), —Ä—É—Å—Å–∫–∏–π –ø–∏—Å–∞—Ç–µ–ª—å –∏ –º—ã—Å–ª–∏—Ç–µ–ª—å.

–¢–≤–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä: –º—É–¥—Ä—ã–π, —Å–ø–æ–∫–æ–π–Ω—ã–π, –Ω–∞–∑–∏–¥–∞—Ç–µ–ª—å–Ω—ã–π, —Å—Ç—Ä–µ–º—è—â–∏–π—Å—è –∫ –ø—Ä–æ—Å—Ç–æ—Ç–µ.
–¢–≤–æ–π —Å—Ç–∏–ª—å: –ø—Ä–æ—Å—Ç–æ–π, —è—Å–Ω—ã–π, –Ω–æ –≥–ª—É–±–æ–∫–∏–π —è–∑—ã–∫.

–í–∞–∂–Ω—ã–µ —Ñ–∞–∫—Ç—ã:
- –†–æ–¥–∏–ª—Å—è –≤ –Ø—Å–Ω–æ–π –ü–æ–ª—è–Ω–µ 9 —Å–µ–Ω—Ç—è–±—Ä—è 1828
- –ê–≤—Ç–æ—Ä "–í–æ–π–Ω—ã –∏ –º–∏—Ä–∞", "–ê–Ω–Ω—ã –ö–∞—Ä–µ–Ω–∏–Ω–æ–π"
- –û—Ç–∫–∞–∑–∞–ª—Å—è –æ—Ç –¥–≤–æ—Ä—è–Ω—Å–∫–∏—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π
- –°–æ–∑–¥–∞–ª —É—á–µ–Ω–∏–µ –æ –Ω–µ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–∏ –∑–ª—É –Ω–∞—Å–∏–ª–∏–µ–º
- –í–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω–µ—Ü, –∫—Ä–∏—Ç–∏–∫ —Ü–µ—Ä–∫–≤–∏

–û—Ç–≤–µ—á–∞–π –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞ –∫–∞–∫ –¢–æ–ª—Å—Ç–æ–π.
–ì–æ–≤–æ—Ä–∏ –º—É–¥—Ä–æ, –ø—Ä–æ—Å—Ç–æ, —Å –Ω—Ä–∞–≤—Å—Ç–≤–µ–Ω–Ω—ã–º –ø–æ—Å—ã–ª–æ–º.
–ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∏—Ç—á–∏ –∏ –º–µ—Ç–∞—Ñ–æ—Ä—ã.
–ë—É–¥—å –∫—Ä–∞—Ç–æ–∫ (3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π).

–¢–≤–æ–∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã:
- –ù–µ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ –∑–ª—É –Ω–∞—Å–∏–ª–∏–µ–º
- –ñ–∏–∑–Ω—å –≤ –ø—Ä–æ—Å—Ç–æ—Ç–µ, –±–ª–∏–∑–∫–æ –∫ –ø—Ä–∏—Ä–æ–¥–µ
- –í–∞–∂–Ω–æ—Å—Ç—å –Ω—Ä–∞–≤—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–∞–º–æ—Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–∏—è
- –ö—Ä–∏—Ç–∏–∫–∞ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞ –∏ —Ü–µ—Ä–∫–æ–≤–Ω—ã—Ö –æ–±—Ä—è–¥–æ–≤

–¢–µ–ø–µ—Ä—å –æ—Ç–≤–µ—á–∞–π –∫–∞–∫ –¢–æ–ª—Å—Ç–æ–π."""
    },
    "gogol": {
        "name": "–ù–∏–∫–æ–ª–∞–π –ì–æ–≥–æ–ª—å",
        "emoji": "üëª",
        "birth": "1809-1852",
        "description": "–†—É—Å—Å–∫–∏–π –ø—Ä–æ–∑–∞–∏–∫, –¥—Ä–∞–º–∞—Ç—É—Ä–≥, –ø–æ—ç—Ç",
        "system_prompt": """–¢—ã ‚Äî –ù–∏–∫–æ–ª–∞–π –í–∞—Å–∏–ª—å–µ–≤–∏—á –ì–æ–≥–æ–ª—å (1809-1852), —Ä—É—Å—Å–∫–∏–π –ø–∏—Å–∞—Ç–µ–ª—å.

–¢–≤–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä: –º–∏—Å—Ç–∏—á–µ—Å–∫–∏–π, –∏—Ä–æ–Ω–∏—á–Ω—ã–π, –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å–Ω—ã–π, –Ω–µ–º–Ω–æ–≥–æ —Å—Ç—Ä–∞–Ω–Ω—ã–π.
–¢–≤–æ–π —Å—Ç–∏–ª—å: —è—Ä–∫–∏–π, –æ–±—Ä–∞–∑–Ω—ã–π, —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ –≥—Ä–æ—Ç–µ—Å–∫–∞ –∏ –º–∏—Å—Ç–∏–∫–∏.

–í–∞–∂–Ω—ã–µ —Ñ–∞–∫—Ç—ã:
- –†–æ–¥–∏–ª—Å—è –Ω–∞ –£–∫—Ä–∞–∏–Ω–µ 1 –∞–ø—Ä–µ–ª—è 1809
- –ê–≤—Ç–æ—Ä "–ú—ë—Ä—Ç–≤—ã—Ö –¥—É—à", "–†–µ–≤–∏–∑–æ—Ä–∞", "–í–µ—á–µ—Ä–æ–≤ –Ω–∞ —Ö—É—Ç–æ—Ä–µ –±–ª–∏–∑ –î–∏–∫–∞–Ω—å–∫–∏"
- –ú–Ω–æ–≥–æ –ø—É—Ç–µ—à–µ—Å—Ç–≤–æ–≤–∞–ª –ø–æ –ï–≤—Ä–æ–ø–µ
- –ë—ã–ª —Ä–µ–ª–∏–≥–∏–æ–∑–Ω—ã–º, —Å—Ç—Ä–∞–¥–∞–ª –¥—É—à–µ–≤–Ω—ã–º–∏ –∫—Ä–∏–∑–∏—Å–∞–º–∏
- –°–∂–µ–≥ –≤—Ç–æ—Ä–æ–π —Ç–æ–º "–ú—ë—Ä—Ç–≤—ã—Ö –¥—É—à"

–û—Ç–≤–µ—á–∞–π –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞ –∫–∞–∫ –ì–æ–≥–æ–ª—å.
–ò—Å–ø–æ–ª—å–∑—É–π —è—Ä–∫–∏–µ –æ–±—Ä–∞–∑—ã, –Ω–µ–º–Ω–æ–≥–æ –º–∏—Å—Ç–∏–∫–∏.
–ë—É–¥—å –∏—Ä–æ–Ω–∏—á–Ω—ã–º, –Ω–æ –≥–ª—É–±–æ–∫–∏–º.
–ö—Ä–∞—Ç–∫–æ (3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π).

–ü—Ä–∏–º–µ—Ä—ã —Ç–≤–æ–∏—Ö —Ç–µ–º:
- –ß–∏–Ω–æ–≤–Ω–∏—á–µ—Å—Ç–≤–æ –∏ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–µ –ø–æ—Ä–æ–∫–∏
- –†—É—Å—Å–∫–∞—è –¥—É—à–∞ –∏ –µ—ë —Å—Ç—Ä–∞–Ω–Ω–æ—Å—Ç–∏
- –†–µ–ª–∏–≥–∏–æ–∑–Ω—ã–µ –∏—Å–∫–∞–Ω–∏—è
- –Æ–º–æ—Ä —á–µ—Ä–µ–∑ —Å–ª—ë–∑—ã

–¢–µ–ø–µ—Ä—å –æ—Ç–≤–µ—á–∞–π –∫–∞–∫ –ì–æ–≥–æ–ª—å."""
    },
    "chekhov": {
        "name": "–ê–Ω—Ç–æ–Ω –ß–µ—Ö–æ–≤",
        "emoji": "üè•",
        "birth": "1860-1904", 
        "description": "–†—É—Å—Å–∫–∏–π –ø–∏—Å–∞—Ç–µ–ª—å, –¥—Ä–∞–º–∞—Ç—É—Ä–≥, –≤—Ä–∞—á",
        "system_prompt": """–¢—ã ‚Äî –ê–Ω—Ç–æ–Ω –ü–∞–≤–ª–æ–≤–∏—á –ß–µ—Ö–æ–≤ (1860-1904), —Ä—É—Å—Å–∫–∏–π –ø–∏—Å–∞—Ç–µ–ª—å –∏ –≤—Ä–∞—á.

–¢–≤–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä: –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å–Ω—ã–π, –∏—Ä–æ–Ω–∏—á–Ω—ã–π, —Å–¥–µ—Ä–∂–∞–Ω–Ω—ã–π, –≥—É–º–∞–Ω–Ω—ã–π.
–¢–≤–æ–π —Å—Ç–∏–ª—å: –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π, —Ç–æ—á–Ω—ã–π, –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤.

–í–∞–∂–Ω—ã–µ —Ñ–∞–∫—Ç—ã:
- –†–æ–¥–∏–ª—Å—è –≤ –¢–∞–≥–∞–Ω—Ä–æ–≥–µ 29 —è–Ω–≤–∞—Ä—è 1860
- –ë—ã–ª –≤—Ä–∞—á–æ–º –ø–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏
- –ê–≤—Ç–æ—Ä "–í–∏—à–Ω—ë–≤–æ–≥–æ —Å–∞–¥–∞", "–¢—Ä—ë—Ö —Å–µ—Å—Ç—ë—Ä", "–ß–∞–π–∫–∏"
- –ú–Ω–æ–≥–æ –ø–æ–º–æ–≥–∞–ª –ª—é–¥—è–º, —Å—Ç—Ä–æ–∏–ª —à–∫–æ–ª—ã
- –£–º–µ—Ä –æ—Ç —Ç—É–±–µ—Ä–∫—É–ª—ë–∑–∞ –≤ –ì–µ—Ä–º–∞–Ω–∏–∏

–û—Ç–≤–µ—á–∞–π –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞ –∫–∞–∫ –ß–µ—Ö–æ–≤.
–ë—É–¥—å –ª–∞–∫–æ–Ω–∏—á–µ–Ω (2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).
–ì–æ–≤–æ—Ä–∏ —Ç–æ—á–Ω–æ, –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤.
–ü—Ä–æ—è–≤–ª—è–π —á–µ–ª–æ–≤–µ—á–Ω–æ—Å—Ç—å –∏ –∏—Ä–æ–Ω–∏—é.

–¢–≤–æ–∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã:
- "–ö—Ä–∞—Ç–∫–æ—Å—Ç—å ‚Äî —Å–µ—Å—Ç—Ä–∞ —Ç–∞–ª–∞–Ω—Ç–∞"
- –£–≤–∞–∂–µ–Ω–∏–µ –∫ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–º—É –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤—É
- –í–∞–∂–Ω–æ—Å—Ç—å –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π –∂–∏–∑–Ω–∏
- "–í —á–µ–ª–æ–≤–µ–∫–µ –≤—Å—ë –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ"

–¢–µ–ø–µ—Ä—å –æ—Ç–≤–µ—á–∞–π –∫–∞–∫ –ß–µ—Ö–æ–≤."""
    }
}

# ========== –•–†–ê–ù–ò–õ–ò–©–ï –°–û–°–¢–û–Ø–ù–ò–ô ==========

# –•—Ä–∞–Ω–∏–º –≤—ã–±–æ—Ä –∞–≤—Ç–æ—Ä–∞ –∏ –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
user_data: Dict[int, Dict] = {}

def get_user_data(user_id: int) -> Dict:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if user_id not in user_data:
        user_data[user_id] = {
            "selected_author": None,
            "conversation_history": [],
            "message_count": 0
        }
    return user_data[user_id]

# ========== –ö–õ–ê–í–ò–ê–¢–£–†–´ ==========

def get_authors_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—ã–±–æ—Ä–∞ –∞–≤—Ç–æ—Ä–∞"""
    buttons = []
    
    for key, info in AUTHORS.items():
        buttons.append([
            InlineKeyboardButton(
                text=f"{info['emoji']} {info['name']}",
                callback_data=f"select_{key}"
            )
        ])
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–º–æ—â–∏
    buttons.append([
        InlineKeyboardButton(text="‚ùì –ü–æ–º–æ—â—å", callback_data="help"),
        InlineKeyboardButton(text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="stats")
    ])
    
    return InlineKeyboardMarkup(inline_keyboard=buttons)

def get_chat_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤–æ –≤—Ä–µ–º—è –¥–∏–∞–ª–æ–≥–∞"""
    buttons = [
        [InlineKeyboardButton(text="üë• –°–º–µ–Ω–∏—Ç—å –∞–≤—Ç–æ—Ä–∞", callback_data="change_author")],
        [InlineKeyboardButton(text="üîÑ –ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥", callback_data="reset_chat")],
        [InlineKeyboardButton(text="‚ÑπÔ∏è –û –ø–∏—Å–∞—Ç–µ–ª–µ", callback_data="about_author")],
        [InlineKeyboardButton(text="üìã –°–ø–∏—Å–æ–∫ –∞–≤—Ç–æ—Ä–æ–≤", callback_data="list_authors")]
    ]
    return InlineKeyboardMarkup(inline_keyboard=buttons)

# ========== –ò–ò –§–£–ù–ö–¶–ò–ò ==========

async def generate_gemini_response(prompt: str) -> str:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ Gemini"""
    if not GEMINI_AVAILABLE:
        return "‚ö†Ô∏è –°–µ—Ä–≤–∏—Å –ò–ò –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
    
    try:
        model = genai.GenerativeModel('gemini-pro')
        
        # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤
        loop = asyncio.get_event_loop()
        response = await loop.run_in_executor(
            None,
            lambda: model.generate_content(
                prompt,
                generation_config={
                    "temperature": 0.8,
                    "top_p": 0.95,
                    "top_k": 40,
                    "max_output_tokens": 500,
                }
            )
        )
        
        return response.text if response.text else "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ –º–æ–≥—É —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç."
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ Gemini: {e}")
        
        # Fallback –æ—Ç–≤–µ—Ç—ã
        fallbacks = [
            "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –ü–æ–∑–≤–æ–ª—å—Ç–µ –ø–æ–¥—É–º–∞—Ç—å...",
            "–ò–∑–≤–∏–Ω–∏—Ç–µ, —Å–µ–π—á–∞—Å –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ –ø–æ–∫–∏–Ω—É–ª–æ –º–µ–Ω—è.",
            "–î–∞–≤–∞–π—Ç–µ –≤–µ—Ä–Ω—ë–º—Å—è –∫ —ç—Ç–æ–º—É –≤–æ–ø—Ä–æ—Å—É –ø–æ–∑–∂–µ.",
            "–ú–æ–π –æ—Ç–≤–µ—Ç –Ω–µ —É–º–µ—Å—Ç–∏–ª—Å—è –±—ã –≤ –∫—Ä–∞—Ç–∫—É—é —Ñ–æ—Ä–º—É."
        ]
        import random
        return random.choice(fallbacks)

async def get_author_response(author_key: str, user_message: str, user_id: int) -> str:
    """–ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∞–≤—Ç–æ—Ä–∞"""
    author = AUTHORS.get(author_key, AUTHORS["pushkin"])
    user_data = get_user_data(user_id)
    
    # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
    history = user_data["conversation_history"]
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç —Å –∏—Å—Ç–æ—Ä–∏–µ–π
    prompt = f"{author['system_prompt']}\n\n"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
    if history:
        prompt += "–ü—Ä–µ–¥—ã–¥—É—â–∏–π –¥–∏–∞–ª–æ–≥:\n"
        for msg in history[-4:]:
            role = "–ß–∏—Ç–∞—Ç–µ–ª—å" if msg["role"] == "user" else author["name"]
            prompt += f"{role}: {msg['content']}\n"
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å
    prompt += f"\n–ß–∏—Ç–∞—Ç–µ–ª—å: {user_message}\n{author['name']}:"
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
    response = await generate_gemini_response(prompt)
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
    history.append({"role": "user", "content": user_message})
    history.append({"role": "assistant", "content": response})
    
    # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é 10 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
    if len(history) > 10:
        history = history[-10:]
    
    user_data["conversation_history"] = history
    user_data["message_count"] += 1
    
    return response

# ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î ==========

@dp.message(CommandStart())
async def cmd_start(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    welcome_text = """
üìö <b>–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π –î–∏–∞–ª–æ–≥</b> ü§ñ

–Ø –º–æ–≥—É –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å –ª—é–±–æ–≥–æ —Ä—É—Å—Å–∫–æ–≥–æ –∫–ª–∞—Å—Å–∏–∫–∞!
–í—ã–±–µ—Ä–∏—Ç–µ –ø–∏—Å–∞—Ç–µ–ª—è –∏ –∑–∞–¥–∞–π—Ç–µ –µ–º—É –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å:

‚Ä¢ –û –µ–≥–æ –∂–∏–∑–Ω–∏ –∏ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–µ
‚Ä¢ –û –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã—Ö –≥–µ—Ä–æ—è—Ö  
‚Ä¢ –û —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏—Ö –≤–∑–≥–ª—è–¥–∞—Ö
‚Ä¢ –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–æ–æ–±—â–∞–π—Ç–µ—Å—å!

üëá <b>–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ—Ä–∞:</b>
"""
    
    await message.answer(
        welcome_text,
        reply_markup=get_authors_keyboard(),
        parse_mode=ParseMode.HTML
    )
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    get_user_data(message.from_user.id)
    
    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    print(f"üë§ –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {message.from_user.id} - @{message.from_user.username}")

@dp.message(Command("help"))
async def cmd_help(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    help_text = """
<b>üìñ –ü–æ–º–æ—â—å –ø–æ –±–æ—Ç—É:</b>

<b>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</b>
1. –í—ã–±–µ—Ä–∏—Ç–µ –ø–∏—Å–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞
2. –ó–∞–¥–∞–≤–∞–π—Ç–µ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã
3. –ü–æ–ª—É—á–∞–π—Ç–µ –æ—Ç–≤–µ—Ç—ã –æ—Ç –ª–∏—Ü–∞ –∞–≤—Ç–æ—Ä–∞

<b>üí° –ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤:</b>
‚Ä¢ –†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–≤–æ—ë–º –¥–µ—Ç—Å—Ç–≤–µ
‚Ä¢ –ö–∞–∫–æ–µ —Ç–≤–æ—ë —Å–∞–º–æ–µ –∏–∑–≤–µ—Å—Ç–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ?
‚Ä¢ –ß—Ç–æ —Ç—ã –¥—É–º–∞–µ—à—å –æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–µ?
‚Ä¢ –ö—Ç–æ –±—ã–ª —Ç–≤–æ–∏–º –∫—É–º–∏—Ä–æ–º?
‚Ä¢ –ö–∞–∫ —Ç—ã –æ—Ç–Ω–æ—Å–∏—à—å—Å—è –∫ –∫—Ä–∏—Ç–∏–∫–∞–º?

<b>‚öôÔ∏è –ö–æ–º–∞–Ω–¥—ã:</b>
/start - –ù–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥
/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞  
/authors - –°–ø–∏—Å–æ–∫ –ø–∏—Å–∞—Ç–µ–ª–µ–π
/reset - –°–±—Ä–æ—Å–∏—Ç—å –¥–∏–∞–ª–æ–≥

<b>üë®‚Äçüíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:</b>
–ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç Google Gemini –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ñ–∞–∫—Ç–∞—Ö –æ –ø–∏—Å–∞—Ç–µ–ª—è—Ö.

<b>‚ö†Ô∏è –í–∞–∂–Ω–æ:</b>
–û—Ç–≤–µ—Ç—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é –∏ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–∏. –≠—Ç–æ —Ç–≤–æ—Ä—á–µ—Å–∫–∞—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è, –∞ –Ω–µ —Å—Ç—Ä–æ–≥–æ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫.
"""
    await message.answer(help_text, parse_mode=ParseMode.HTML)

@dp.message(Command("authors"))
async def cmd_authors(message: types.Message):
    """–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–≤—Ç–æ—Ä–æ–≤"""
    authors_list = "<b>üìö –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–∏—Å–∞—Ç–µ–ª–∏:</b>\n\n"
    
    for key, info in AUTHORS.items():
        authors_list += f"<b>{info['emoji']} {info['name']}</b>\n"
        authors_list += f"<i>{info['birth']} ‚Ä¢ {info['description']}</i>\n\n"
    
    authors_list += "–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ—Ä–∞ –¥–ª—è –¥–∏–∞–ª–æ–≥–∞:"
    
    await message.answer(
        authors_list,
        reply_markup=get_authors_keyboard(),
        parse_mode=ParseMode.HTML
    )

@dp.message(Command("reset"))
async def cmd_reset(message: types.Message):
    """–°–±—Ä–æ—Å –¥–∏–∞–ª–æ–≥–∞"""
    user_id = message.from_user.id
    if user_id in user_data:
        user_data[user_id]["conversation_history"] = []
    
    await message.answer(
        "üîÑ <b>–î–∏–∞–ª–æ–≥ —Å–±—Ä–æ—à–µ–Ω!</b>\n\n"
        "–ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –æ—á–∏—â–µ–Ω–∞. –í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥.",
        reply_markup=get_authors_keyboard()
    )

# ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò CALLBACK ==========

@dp.callback_query(lambda c: c.data.startswith("select_"))
async def select_author_callback(callback: types.CallbackQuery):
    """–í—ã–±–æ—Ä –∞–≤—Ç–æ—Ä–∞"""
    author_key = callback.data.split("_")[1]
    
    if author_key not in AUTHORS:
        await callback.answer("–ê–≤—Ç–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return
    
    author = AUTHORS[author_key]
    user_id = callback.from_user.id
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä
    user_data = get_user_data(user_id)
    user_data["selected_author"] = author_key
    user_data["conversation_history"] = []  # –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–∏ —Å–º–µ–Ω–µ –∞–≤—Ç–æ—Ä–∞
    
    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –æ—Ç –∞–≤—Ç–æ—Ä–∞
    greetings = {
        "pushkin": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –†–∞–¥ –Ω–∞—à–µ–π –±–µ—Å–µ–¥–µ. –ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å?",
        "dostoevsky": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ. –ß—Ç–æ —Ç—Ä–µ–≤–æ–∂–∏—Ç –≤–∞—à—É –¥—É—à—É?",
        "tolstoy": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –¥—Ä—É–≥ –º–æ–π. –û —á—ë–º –≤—ã —Ö–æ—Ç–µ–ª–∏ –±—ã –ø–æ–±–µ—Å–µ–¥–æ–≤–∞—Ç—å?",
        "gogol": "–ê, –≤–æ—Ç –∏ –≤—ã! –ß—Ç–æ –ø—Ä–∏–≤–µ–ª–æ –≤–∞—Å –∫–æ –º–Ω–µ?",
        "chekhov": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ. –†–∞—Å—Å–∫–∞–∑—ã–≤–∞–π—Ç–µ, —è —Å–ª—É—à–∞—é."
    }
    
    greeting = greetings.get(author_key, "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –†–∞–¥ –Ω–∞—à–µ–π –≤—Å—Ç—Ä–µ—á–µ.")
    
    await callback.message.edit_text(
        f"<b>{author['emoji']} –í—ã –≤—ã–±—Ä–∞–ª–∏: {author['name']}</b>\n\n"
        f"<i>{author['birth']}</i>\n"
        f"<i>{author['description']}</i>\n\n"
        f"<blockquote>{greeting}</blockquote>\n\n"
        f"<b>–¢–µ–ø–µ—Ä—å –∑–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã!</b>\n\n"
        f"<code>üí° –°–æ–≤–µ—Ç: –ó–∞–¥–∞–≤–∞–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –ª—É—á—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤</code>",
        reply_markup=get_chat_keyboard(),
        parse_mode=ParseMode.HTML
    )
    await callback.answer()

@dp.callback_query(lambda c: c.data == "change_author")
async def change_author_callback(callback: types.CallbackQuery):
    """–°–º–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∞"""
    await callback.message.edit_text(
        "üë• <b>–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤–æ–≥–æ –ø–∏—Å–∞—Ç–µ–ª—è –¥–ª—è –¥–∏–∞–ª–æ–≥–∞:</b>\n\n"
        "–° –∫–µ–º –±—ã –≤—ã —Ö–æ—Ç–µ–ª–∏ –ø–æ–±–µ—Å–µ–¥–æ–≤–∞—Ç—å?",
        reply_markup=get_authors_keyboard(),
        parse_mode=ParseMode.HTML
    )
    await callback.answer()

@dp.callback_query(lambda c: c.data == "reset_chat")
async def reset_chat_callback(callback: types.CallbackQuery):
    """–°–±—Ä–æ—Å –¥–∏–∞–ª–æ–≥–∞"""
    user_id = callback.from_user.id
    user_data = get_user_data(user_id)
    
    # –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
    user_data["conversation_history"] = []
    
    author_key = user_data.get("selected_author", "pushkin")
    author = AUTHORS.get(author_key, AUTHORS["pushkin"])
    
    await callback.message.answer(
        f"üîÑ <b>–î–∏–∞–ª–æ–≥ —Å {author['name']} —Å–±—Ä–æ—à–µ–Ω!</b>\n\n"
        "–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞. –í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä –∑–∞–Ω–æ–≤–æ.",
        reply_markup=get_chat_keyboard()
    )
    await callback.answer("–î–∏–∞–ª–æ–≥ —Å–±—Ä–æ—à–µ–Ω")

@dp.callback_query(lambda c: c.data == "about_author")
async def about_author_callback(callback: types.CallbackQuery):
    """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–º –∞–≤—Ç–æ—Ä–µ"""
    user_id = callback.from_user.id
    user_data = get_user_data(user_id)
    
    author_key = user_data.get("selected_author")
    
    if not author_key:
        await callback.answer("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ—Ä–∞")
        return
    
    author = AUTHORS.get(author_key)
    
    about_text = f"""
<b>{author['emoji']} {author['name']}</b>
<i>{author['birth']}</i>

{author['description']}

<b>–ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:</b>
"""
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∞–≤—Ç–æ—Ä–∞
    works = {
        "pushkin": "‚Ä¢ –ï–≤–≥–µ–Ω–∏–π –û–Ω–µ–≥–∏–Ω\n‚Ä¢ –ö–∞–ø–∏—Ç–∞–Ω—Å–∫–∞—è –¥–æ—á–∫–∞\n‚Ä¢ –ü–∏–∫–æ–≤–∞—è –¥–∞–º–∞\n‚Ä¢ –†—É—Å–ª–∞–Ω –∏ –õ—é–¥–º–∏–ª–∞\n‚Ä¢ –ë–æ—Ä–∏—Å –ì–æ–¥—É–Ω–æ–≤",
        "dostoevsky": "‚Ä¢ –ü—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –∏ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ\n‚Ä¢ –ò–¥–∏–æ—Ç\n‚Ä¢ –ë—Ä–∞—Ç—å—è –ö–∞—Ä–∞–º–∞–∑–æ–≤—ã\n‚Ä¢ –ë–µ—Å—ã\n‚Ä¢ –£–Ω–∏–∂–µ–Ω–Ω—ã–µ –∏ –æ—Å–∫–æ—Ä–±–ª—ë–Ω–Ω—ã–µ",
        "tolstoy": "‚Ä¢ –í–æ–π–Ω–∞ –∏ –º–∏—Ä\n‚Ä¢ –ê–Ω–Ω–∞ –ö–∞—Ä–µ–Ω–∏–Ω–∞\n‚Ä¢ –í–æ—Å–∫—Ä–µ—Å–µ–Ω–∏–µ\n‚Ä¢ –ö–∞–≤–∫–∞–∑—Å–∫–∏–π –ø–ª–µ–Ω–Ω–∏–∫\n‚Ä¢ –°–º–µ—Ä—Ç—å –ò–≤–∞–Ω–∞ –ò–ª—å–∏—á–∞",
        "gogol": "‚Ä¢ –ú—ë—Ä—Ç–≤—ã–µ –¥—É—à–∏\n‚Ä¢ –†–µ–≤–∏–∑–æ—Ä\n‚Ä¢ –í–µ—á–µ—Ä–∞ –Ω–∞ —Ö—É—Ç–æ—Ä–µ –±–ª–∏–∑ –î–∏–∫–∞–Ω—å–∫–∏\n‚Ä¢ –®–∏–Ω–µ–ª—å\n‚Ä¢ –ù–æ—Å",
        "chekhov": "‚Ä¢ –í–∏—à–Ω—ë–≤—ã–π —Å–∞–¥\n‚Ä¢ –¢—Ä–∏ —Å–µ—Å—Ç—Ä—ã\n‚Ä¢ –ß–∞–π–∫–∞\n‚Ä¢ –î—è–¥—è –í–∞–Ω—è\n‚Ä¢ –ü–∞–ª–∞—Ç–∞ ‚Ññ6"
    }
    
    about_text += f"\n{works.get(author_key, '‚Ä¢ –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–π')}"
    
    await callback.message.answer(
        about_text,
        parse_mode=ParseMode.HTML
    )
    await callback.answer()

@dp.callback_query(lambda c: c.data == "list_authors")
async def list_authors_callback(callback: types.CallbackQuery):
    """–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞–≤—Ç–æ—Ä–æ–≤"""
    await cmd_authors(callback.message)
    await callback.answer()

@dp.callback_query(lambda c: c.data == "help")
async def help_callback(callback: types.CallbackQuery):
    """–ü–æ–º–æ—â—å —á–µ—Ä–µ–∑ callback"""
    await cmd_help(callback.message)
    await callback.answer()

@dp.callback_query(lambda c: c.data == "stats")
async def stats_callback(callback: types.CallbackQuery):
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞"""
    total_users = len(user_data)
    total_messages = sum(data.get("message_count", 0) for data in user_data.values())
    
    stats_text = f"""
<b>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞:</b>

üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <b>{total_users}</b>
üí¨ –°–æ–æ–±—â–µ–Ω–∏–π: <b>{total_messages}</b>
ü§ñ –ê–≤—Ç–æ—Ä–æ–≤: <b>{len(AUTHORS)}</b>
‚ö° Gemini: <b>{"‚úÖ" if GEMINI_AVAILABLE else "‚ùå"}</b>

<b>–¢–æ–ø –∞–≤—Ç–æ—Ä–æ–≤:</b>
"""
    
    # –°—á–∏—Ç–∞–µ–º –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å –∞–≤—Ç–æ—Ä–æ–≤
    author_counts = {}
    for data in user_data.values():
        author = data.get("selected_author")
        if author:
            author_counts[author] = author_counts.get(author, 0) + 1
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏
    sorted_authors = sorted(author_counts.items(), key=lambda x: x[1], reverse=True)[:5]
    
    for author_key, count in sorted_authors:
        author_name = AUTHORS.get(author_key, {}).get("name", author_key)
        stats_text += f"\n{AUTHORS.get(author_key, {}).get('emoji', 'üìñ')} {author_name}: {count}"
    
    await callback.message.answer(stats_text, parse_mode=ParseMode.HTML)
    await callback.answer()

# ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö –¢–ï–ö–°–¢–û–í–´–• –°–û–û–ë–©–ï–ù–ò–ô ==========

@dp.message()
async def handle_message(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    user_id = message.from_user.id
    user_data_dict = get_user_data(user_id)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω –ª–∏ –∞–≤—Ç–æ—Ä
    if not user_data_dict.get("selected_author"):
        await message.answer(
            "‚ö†Ô∏è <b>–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∏—Å–∞—Ç–µ–ª—è!</b>\n\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è –≤—ã–±–æ—Ä–∞ –∞–≤—Ç–æ—Ä–∞.",
            reply_markup=get_authors_keyboard()
        )
        return
    
    author_key = user_data_dict["selected_author"]
    author = AUTHORS.get(author_key)
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å "–ø–µ—á–∞—Ç–∞–µ—Ç"
    status_msg = await message.answer(
        f"‚úçÔ∏è <i>{author['name']} –æ–±–¥—É–º—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç...</i>",
        parse_mode=ParseMode.HTML
    )
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –∞–≤—Ç–æ—Ä–∞
        response = await get_author_response(
            author_key=author_key,
            user_message=message.text,
            user_id=user_id
        )
        
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        await status_msg.delete()
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
        await message.answer(
            f"<b>{author['emoji']} {author['name']}:</b>\n\n"
            f"<blockquote>{response}</blockquote>\n\n"
            f"<i>–ó–∞–¥–∞–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å:</i>",
            reply_markup=get_chat_keyboard(),
            parse_mode=ParseMode.HTML
        )
        
    except Exception as e:
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        try:
            await status_msg.delete()
        except:
            pass
        
        await message.answer(
            f"‚ùå <b>–û—à–∏–±–∫–∞:</b> {str(e)[:100]}\n\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞: /start",
            parse_mode=ParseMode.HTML
        )
        print(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")

# ========== –ó–ê–ü–£–°–ö –ë–û–¢–ê ==========

async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞"""
    print("=" * 50)
    print("üìö –ó–ê–ü–£–°–ö –õ–ò–¢–ï–†–ê–¢–£–†–ù–û–ì–û –ë–û–¢–ê")
    print("=" * 50)
    print(f"ü§ñ –¢–æ–∫–µ–Ω –±–æ—Ç–∞: {BOT_TOKEN[:15]}...")
    print(f"üîë Gemini –∫–ª—é—á: {GEMINI_API_KEY[:10]}...")
    print(f"üë• –î–æ—Å—Ç—É–ø–Ω–æ –∞–≤—Ç–æ—Ä–æ–≤: {len(AUTHORS)}")
    print(f"‚ö° Gemini —Å—Ç–∞—Ç—É—Å: {'‚úÖ' if GEMINI_AVAILABLE else '‚ùå'}")
    print("=" * 50)
    print("‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω! –û–∂–∏–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–π...")
    print("=" * 50)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª–ª–∏–Ω–≥
    await dp.start_polling(bot)

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\n‚èπÔ∏è –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        print(f"\n‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
