    async def generate_author_response(
        self, 
        author_key: str, 
        author_name: str,
        user_message: str, 
        conversation_history: Optional[List[Dict]] = None
    ) -> str:
        """Генерирует ответ от лица писателя"""
        
        if not self.available:
            return self._get_fallback_response(author_name)
        
        try:
            # Создаем системный промпт
            system_prompt = self._get_author_system_prompt(author_key, author_name)
            
            # Формируем полный промпт
            full_prompt = f"""{system_prompt}

ВАЖНОЕ ПРАВИЛО: Никогда не начинай ответ со слов:
- "Ах, этот вопрос!"
- "Интересный вопрос!"
- "Позвольте мне подумать..."
- "Как [имя], я бы сказал..."
- Любые шаблонные фразы.

Начинай ответ КАК ПИСАТЕЛЬ, от первого лица, сразу по сути.

ТЕКУЩИЙ ВОПРОС: {user_message}

ТВОЙ ОТВЕТ (как {author_name}):"""
            
            # Асинхронный вызов Gemini с более строгими настройками
            loop = asyncio.get_event_loop()
            response = await loop.run_in_executor(
                None,
                lambda: self.model.generate_content(
                    full_prompt,
                    generation_config={
                        "temperature": 0.7,  # Меньше случайности
                        "top_p": 0.8,
                        "top_k": 40,
                        "max_output_tokens": 400,
                    }
                )
            )
            
            if response.text:
                # Очищаем ответ от шаблонных фраз
                cleaned_response = response.text.strip()
                
                # Удаляем возможные шаблонные начала
                bad_starts = [
                    "Ах, этот вопрос!",
                    "Интересный вопрос!",
                    "Позвольте мне подумать",
                    f"Как {author_name}, я бы сказал",
                    "Ну что ж,",
                    "Что ж,",
                    "Итак,"
                ]
                
                for bad_start in bad_starts:
                    if cleaned_response.startswith(bad_start):
                        cleaned_response = cleaned_response[len(bad_start):].strip()
                        if cleaned_response.startswith(','):
                            cleaned_response = cleaned_response[1:].strip()
                        if cleaned_response.startswith(' '):
                            cleaned_response = cleaned_response.strip()
                
                return cleaned_response if cleaned_response else self._get_fallback_response(author_name)
            else:
                return self._get_fallback_response(author_name)
                
        except Exception as e:
            print(f"❌ Ошибка Gemini: {e}")
            return self._get_fallback_response(author_name)
