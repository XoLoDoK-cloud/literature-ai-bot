# ========== gigachat_client.py ==========
import asyncio
import logging
import random
from typing import Dict, List, Optional
from datetime import datetime

logger = logging.getLogger(__name__)

class GigaChatClient:
    """–ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å GigaChat API –∏–ª–∏ –∑–∞–≥–ª—É—à–∫–∞–º–∏"""
    
    def __init__(self, credentials: str = None, model: str = "GigaChat:latest"):
        self.credentials = credentials
        self.model = model
        self.available = False  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫–∏
        
        if self.credentials and self.credentials != "–≤–∞—à_–∫–ª—é—á_gigachat":
            print("‚ö†Ô∏è –ù–∞—Å—Ç–æ—è—â–∏–π GigaChat —Ç—Ä–µ–±—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ gigachat")
            print("   pip install gigachat")
            print("   –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–º–Ω—ã–µ –∑–∞–≥–ª—É—à–∫–∏")
    
    async def generate_response(self, author_key: str, author_name: str, 
                               user_message: str, conversation_history: list = None,
                               gigachad_mode: bool = False, what_if_mode: bool = False) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç –ª–∏—Ü–∞ –∞–≤—Ç–æ—Ä–∞"""
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–º–Ω—ã–µ –∑–∞–≥–ª—É—à–∫–∏
        return self._get_intelligent_fallback(author_key, user_message, gigachad_mode, what_if_mode)
    
    def _get_intelligent_fallback(self, author_key: str, user_message: str, 
                                 gigachad_mode: bool, what_if_mode: bool) -> str:
        """–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–∞–≥–ª—É—à–∫–∏"""
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        question_lower = user_message.lower()
        
        if "—á—Ç–æ –µ—Å–ª–∏" in question_lower or what_if_mode:
            what_if_responses = [
                "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞... –î–æ–ø—É—Å—Ç–∏–º, —Å–æ–±—ã—Ç–∏—è –ø–æ—à–ª–∏ –±—ã –∏–Ω–∞—á–µ. –í–æ–∑–º–æ–∂–Ω–æ, —è –Ω–∞–ø–∏—Å–∞–ª –±—ã —Å–æ–≤—Å–µ–º –¥—Ä—É–≥–∏–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è.",
                "–õ—é–±–æ–ø—ã—Ç–Ω–æ–µ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –í –∏–Ω—ã—Ö –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞—Ö –º–æ—ë —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ –º–æ–≥–ª–æ –ø—Ä–∏–Ω—è—Ç—å –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã.",
                "–ï—Å–ª–∏ –±—ã... –î–∞, —ç—Ç–æ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞–¥—É–º–∞—Ç—å—Å—è –æ –Ω–µ—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö."
            ]
            return random.choice(what_if_responses)
        
        elif gigachad_mode or author_key == "gigachad":
            # –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –ø–æ–¥ —Ç–µ–º—É –≤–æ–ø—Ä–æ—Å–∞
            if any(word in question_lower for word in ["–∫–Ω–∏–≥", "—á–∏—Ç–∞—Ç—å", "—á—Ç–µ–Ω–∏–µ"]):
                gigachad_responses = [
                    "üí™ –ö–ù–ò–ì–ò ‚Äî –≠–¢–û –ñ–ï–õ–ï–ó–û –î–õ–Ø –ú–û–ó–ì–ê! –ß–∏—Ç–∞–π –∫–∞–∂–¥—ã–π –¥–µ–Ω—å, –∫–∞–∫ –¥–µ–ª–∞–µ—à—å –ø–æ–¥—Ö–æ–¥—ã –Ω–∞ –∂–∏–º!",
                    "üöÄ –ß–¢–ï–ù–ò–ï ‚Äî –ü–†–û–ö–ê–ß–ö–ê –°–û–ó–ù–ê–ù–ò–Ø! –ù–µ –∂–¥–∏ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è, —Å–æ–∑–¥–∞–≤–∞–π –µ–≥–æ —Å–∞–º —á–µ—Ä–µ–∑ –∫–Ω–∏–≥–∏!",
                    "üèãÔ∏è –°–õ–£–®–ê–ô –°–Æ–î–ê! –ù–∞—Å—Ç–æ—è—â–∏–µ –º—É–∂—á–∏–Ω—ã —á–∏—Ç–∞—é—Ç –∫–ª–∞—Å—Å–∏–∫—É —É—Ç—Ä–æ–º, –ø–æ—Å–ª–µ —Å–æ—Ç–Ω–∏ –æ—Ç–∂–∏–º–∞–Ω–∏–π!"
                ]
            elif any(word in question_lower for word in ["—Å–º—ã—Å–ª", "–∂–∏–∑–Ω", "—Ñ–∏–ª–æ—Å–æ—Ñ"]):
                gigachad_responses = [
                    "üî• –°–ú–´–°–õ ‚Äî –í –î–ï–ô–°–¢–í–ò–ò! –ù–µ –∏—â–∏ —Å–º—ã—Å–ª, —Å–æ–∑–¥–∞–≤–∞–π –µ–≥–æ —Å–≤–æ–∏–º–∏ –ø–æ—Å—Ç—É–ø–∫–∞–º–∏!",
                    "üí™ –§–ò–õ–û–°–û–§–ò–Ø ‚Äî –≠–¢–û –¢–†–ï–ù–ò–†–û–í–ö–ê –£–ú–ê! –î—É–º–∞–π –∫–∞–∫ —Å—Ç–æ–∏–∫, –¥–µ–π—Å—Ç–≤—É–π –∫–∞–∫ –≤–æ–∏–Ω!",
                    "üöÄ –ñ–ò–ó–ù–¨ ‚Äî –ü–û–õ–ò–ì–û–ù –î–õ–Ø –†–û–°–¢–ê! –ö–∞–∂–¥–∞—è –∫–Ω–∏–≥–∞, –∫–∞–∂–¥–∞—è –º—ã—Å–ª—å ‚Äî —ç—Ç–æ –ø–æ–¥—Ö–æ–¥ –∫ —Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é –ª—É—á—à–µ!"
                ]
            else:
                gigachad_responses = [
                    "üí™ –°–ï–†–í–ï–†–´ –ö–ê–ß–ê–Æ–¢–°–Ø! –ò—Å–ø–æ–ª—å–∑—É–π –ø–∞—É–∑—É ‚Äî –≤–æ–∑—å–º–∏ –∫–Ω–∏–≥—É –∏ –ø—Ä–æ–∫–∞—á–∞–π –º–æ–∑–≥!",
                    "üî• –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ò–°–ü–´–¢–ê–ù–ò–Ø! –ü–æ–∫–∞ —á–∏–Ω–∏–º ‚Äî –¥—É–º–∞–π —Å–∞–º! –ù–∞—Å—Ç–æ—è—â–∏–π –º—É–∂—á–∏–Ω–∞ —É–º–µ–µ—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å!",
                    "üöÄ –ù–ï–ô–†–û–°–ï–¢–¨ –ù–ê –ü–ï–†–ï–ö–£–†–ï! –í–æ–∑—å–º–∏ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤–æ–ø—Ä–æ—Å —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ!"
                ]
            return random.choice(gigachad_responses)
        
        else:
            # –£–º–Ω—ã–µ –∑–∞–≥–ª—É—à–∫–∏ –¥–ª—è –∫–ª–∞—Å—Å–∏–∫–æ–≤
            if author_key == "pushkin":
                responses = [
                    "–ü–æ–∑–≤–æ–ª—å—Ç–µ, —è –æ–±–¥—É–º–∞—é –≤–∞—à –≤–æ–ø—Ä–æ—Å... –í–µ–¥—å –∫–∞–∂–¥–∞—è –º—ã—Å–ª—å —Ç—Ä–µ–±—É–µ—Ç –∏–∑—è—â–Ω–æ–≥–æ –≤—ã—Ä–∞–∂–µ–Ω–∏—è.",
                    "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –ø–æ–≤–æ—Ä–æ—Ç —Ç–µ–º—ã... –ú–Ω–µ –Ω—É–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å—Å—è —Å –º—ã—Å–ª—è–º–∏, —á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å –¥–æ—Å—Ç–æ–π–Ω–æ.",
                    "–ß—Ç–æ –∂, –≤–æ–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è... –î–∞–π—Ç–µ –º–Ω–µ –º–≥–Ω–æ–≤–µ–Ω–∏–µ –¥–ª—è —Å–æ–∑–µ—Ä—Ü–∞–Ω–∏—è."
                ]
            elif author_key == "dostoevsky":
                responses = [
                    "–í–æ–ø—Ä–æ—Å –≥–ª—É–±–æ–∫–∏–π... –¢—Ä–µ–±—É–µ—Ç –ø–æ–≥—Ä—É–∂–µ–Ω–∏—è –≤ —Å–∞–º—ã–µ —Ç—ë–º–Ω—ã–µ —É–≥–æ–ª–∫–∏ –¥—É—à–∏.",
                    "–í—ã –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç–µ –≤–∞–∂–Ω–æ–µ... –ü–æ–∑–≤–æ–ª—å—Ç–µ –º–Ω–µ –ø–æ—Ä–∞–∑–º—ã—à–ª—è—Ç—å –æ —Å–º—ã—Å–ª–µ —ç—Ç–æ–≥–æ.",
                    "–°–ª–æ–∂–Ω—ã–π –≤–æ–ø—Ä–æ—Å... –û–Ω –∫–∞—Å–∞–µ—Ç—Å—è –æ—Å–Ω–æ–≤ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–≥–æ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è."
                ]
            elif author_key == "tolstoy":
                responses = [
                    "–í–æ–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ—Å—Ç–æ–≥–æ, –Ω–æ –≥–ª—É–±–æ–∫–æ–≥–æ –æ—Å–º—ã—Å–ª–µ–Ω–∏—è... –î–∞–π—Ç–µ –º–Ω–µ —Å–æ–±—Ä–∞—Ç—å—Å—è —Å –º—ã—Å–ª—è–º–∏.",
                    "–í–∞—à –≤–æ–ø—Ä–æ—Å –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞–¥—É–º–∞—Ç—å—Å—è –æ –≤–∞–∂–Ω—ã—Ö –≤–µ—â–∞—Ö... –ü–æ–∑–≤–æ–ª—å—Ç–µ –º–Ω–µ –æ–±–¥—É–º–∞—Ç—å –æ—Ç–≤–µ—Ç.",
                    "–ß—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å –º—É–¥—Ä–æ, –Ω—É–∂–Ω–æ –≤—Ä–µ–º—è –¥–ª—è —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è... –ü—Ä–æ—à—É –º–∏–Ω—É—Ç—É."
                ]
            elif author_key == "gogol":
                responses = [
                    "–õ—é–±–æ–ø—ã—Ç–Ω–æ... –≠—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å –∏–º–µ–µ—Ç —Å—Ç—Ä–∞–Ω–Ω—ã–π, –ø–æ—á—Ç–∏ –º–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—Ç–µ–Ω–æ–∫.",
                    "–ê—Ö, –∫–∞–∫–æ–π –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –ø–æ–≤–æ—Ä–æ—Ç... –ü–æ–∑–≤–æ–ª—å—Ç–µ –º–Ω–µ –æ–±–¥—É–º–∞—Ç—å —ç—Ç—É —Å—Ç—Ä–∞–Ω–Ω–æ—Å—Ç—å.",
                    "–í–æ–ø—Ä–æ—Å, –¥–æ—Å—Ç–æ–π–Ω—ã–π —Å–∞–º–æ–≥–æ –ø—Ä–∏—á—É–¥–ª–∏–≤–æ–≥–æ —Å—é–∂–µ—Ç–∞... –ú–Ω–µ –Ω—É–∂–Ω–æ —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏—Ç—å—Å—è."
                ]
            elif author_key == "chekhov":
                responses = [
                    "–í–æ–ø—Ä–æ—Å —è—Å–µ–Ω... –¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ—á–Ω—ã–π –∏ –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π –æ—Ç–≤–µ—Ç. –î–∞–π—Ç–µ –º–Ω–µ –ø–æ–¥—É–º–∞—Ç—å.",
                    "–ü–æ–∑–≤–æ–ª—å—Ç–µ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –∫—Ä–∞—Ç–∫–æ, –Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω–æ... –ú–Ω–µ –Ω—É–∂–Ω–∞ –º–∏–Ω—É—Ç–∞.",
                    "–ß—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤, –Ω—É–∂–Ω–æ —Ö–æ—Ä–æ—à–æ –æ–±–¥—É–º–∞—Ç—å... –ü—Ä–æ—à—É —Ç–µ—Ä–ø–µ–Ω–∏—è."
                ]
            else:
                responses = [
                    "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å... –ü–æ–∑–≤–æ–ª—å—Ç–µ –º–Ω–µ –æ–±–¥—É–º–∞—Ç—å –µ–≥–æ –∫–∞–∫ —Å–ª–µ–¥—É–µ—Ç.",
                    "–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ä–µ–º—è –¥–ª—è –¥–æ—Å—Ç–æ–π–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞... –ü—Ä–æ—à—É –º–∏–Ω—É—Ç–∫—É —Ç–µ—Ä–ø–µ–Ω–∏—è.",
                    "–í–æ–ø—Ä–æ—Å –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—Ç –≥–ª—É–±–æ–∫–æ–≥–æ –æ—Å–º—ã—Å–ª–µ–Ω–∏—è... –î–∞–π—Ç–µ –º–Ω–µ —Å–æ–±—Ä–∞—Ç—å—Å—è —Å –º—ã—Å–ª—è–º–∏."
                ]
            
            return random.choice(responses)
