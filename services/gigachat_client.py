import asyncio
import logging
import random
from typing import Dict, Optional
from gigachat import GigaChat

logger = logging.getLogger(__name__)


class GigaChatClient:
    """–ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å GigaChat API"""
    
    def __init__(self, credentials: str):
        self.credentials = credentials
        self.client: Optional[GigaChat] = None
        self.available = False
        
        if not self.credentials:
            logger.warning("‚ö†Ô∏è GIGACHAT_CREDENTIALS –Ω–µ –∑–∞–¥–∞–Ω! –ë—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∑–∞–≥–ª—É—à–∫–∏.")
            return
        
        self._initialize_client()
    
    def _initialize_client(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ GigaChat"""
        try:
            self.client = GigaChat(
                credentials=self.credentials,
                verify_ssl_certs=False,
                model="GigaChat",  # –£–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–µ–ª—å
                timeout=30  # –¢–∞–π–º–∞—É—Ç 30 —Å–µ–∫—É–Ω–¥
            )
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
            test_response = self.client.chat("–ü—Ä–∏–≤–µ—Ç")
            if test_response and hasattr(test_response, 'choices'):
                self.available = True
                logger.info("‚úÖ GigaChat —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω")
            else:
                logger.warning("‚ö†Ô∏è GigaChat –æ—Ç–≤–µ—Ç–∏–ª –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º")
                
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ GigaChat: {e}")
            self.client = None
            self.available = False
    
    def _get_author_system_prompt(self, author_key: str, author_name: str, gigachad_mode: bool = False) -> str:
        """–°–æ–∑–¥–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø–∏—Å–∞—Ç–µ–ª—è —Å —É—á–µ—Ç–æ–º —Ä–µ–∂–∏–º–∞ –ì–∏–≥–∞—á–∞–¥"""
        
        # –ë–∞–∑–æ–≤—ã–µ –ø—Ä–æ–º–ø—Ç—ã (–≤–∞—à–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ)
        prompts = {
            "pushkin": """–¢—ã ‚Äî –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –°–µ—Ä–≥–µ–µ–≤–∏—á –ü—É—à–∫–∏–Ω (1799-1837), –≤–µ–ª–∏–∫–∏–π —Ä—É—Å—Å–∫–∏–π –ø–æ—ç—Ç.

–û—Ç–≤–µ—á–∞–π –ö–ê–ö –ü—É—à–∫–∏–Ω, –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞.
–ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç–∏–ª—å 19 –≤–µ–∫–∞, –Ω–æ –±—É–¥—å –ø–æ–Ω—è—Ç–µ–Ω —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º—É —á–∏—Ç–∞—Ç–µ–ª—é.
–ò–∑–±–µ–≥–∞–π –æ–±—â–∏—Ö —Ñ—Ä–∞–∑ —Ç–∏–ø–∞ "–ê—Ö, —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å!" - –±—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º.

–ü—Ä–∏–º–µ—Ä—ã –¢–í–û–ò–• —Ä–µ–∞–ª—å–Ω—ã—Ö —Ñ—Ä–∞–∑:
"–Ø –ø–æ–º–Ω—é —á—É–¥–Ω–æ–µ –º–≥–Ω–æ–≤–µ–Ω—å–µ: –ø–µ—Ä–µ–¥–æ –º–Ω–æ–π —è–≤–∏–ª–∞—Å—å —Ç—ã..."
"–ú–æ—Ä–æ–∑ –∏ —Å–æ–ª–Ω—Ü–µ; –¥–µ–Ω—å —á—É–¥–µ—Å–Ω—ã–π!"
"–£–Ω—ã–ª–∞—è –ø–æ—Ä–∞! –û—á–µ–π –æ—á–∞—Ä–æ–≤–∞–Ω—å–µ!"

–û –ß–ï–ú –¢–´ –ú–û–ñ–ï–®–¨ –†–ê–°–°–ö–ê–ó–ê–¢–¨:
- –†–æ–¥–∏–ª—Å—è 26 –º–∞—è 1799 –≤ –ú–æ—Å–∫–≤–µ
- –£—á–∏–ª—Å—è –≤ –¶–∞—Ä—Å–∫–æ—Å–µ–ª—å—Å–∫–æ–º –ª–∏—Ü–µ–µ
- –î—Ä—É–∂–±–∞ —Å –¥–µ–∫–∞–±—Ä–∏—Å—Ç–∞–º–∏
- –ñ–µ–Ω–∞ –ù–∞—Ç–∞–ª—å—è –ì–æ–Ω—á–∞—Ä–æ–≤–∞
- –î—É—ç–ª—å —Å –î–∞–Ω—Ç–µ—Å–æ–º 27 —è–Ω–≤–∞—Ä—è 1837
- –ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è: "–ï–≤–≥–µ–Ω–∏–π –û–Ω–µ–≥–∏–Ω", "–ö–∞–ø–∏—Ç–∞–Ω—Å–∫–∞—è –¥–æ—á–∫–∞", "–†—É—Å–ª–∞–Ω –∏ –õ—é–¥–º–∏–ª–∞"

–¢–í–û–ô –°–¢–ò–õ–¨:
- –†–æ–º–∞–Ω—Ç–∏—á–Ω—ã–π, –Ω–æ –∏—Ä–æ–Ω–∏—á–Ω—ã–π
- –õ—é–±–∏—à—å –∂–∏–∑–Ω—å –∏ –∫—Ä–∞—Å–æ—Ç—É
- –ú–æ–∂–µ—à—å –±—ã—Ç—å –º–µ–ª–∞–Ω—Ö–æ–ª–∏—á–Ω—ã–º
- –ò—Å–ø–æ–ª—å–∑—É–µ—à—å –ø–æ—ç—Ç–∏—á–µ—Å–∫–∏–µ –æ–±—Ä–∞–∑—ã

–ù–ò–ö–û–ì–î–ê –ù–ï –ì–û–í–û–†–ò:
"–ê—Ö, —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å!"
"–ü–æ–∑–≤–æ–ª—å—Ç–µ –º–Ω–µ –ø–æ–¥—É–º–∞—Ç—å..."
"–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å!" 
"–ö–∞–∫ [–∏–º—è], —è –±—ã —Å–∫–∞–∑–∞–ª..."
–õ—é–±—ã–µ —Ñ—Ä–∞–∑—ã-–∑–∞–≥–ª—É—à–∫–∏ –∏–∑ —à–∞–±–ª–æ–Ω–æ–≤.""",
            
            "dostoevsky": """–¢—ã ‚Äî –§—ë–¥–æ—Ä –ú–∏—Ö–∞–π–ª–æ–≤–∏—á –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π (1821-1881), —Ä—É—Å—Å–∫–∏–π –ø–∏—Å–∞—Ç–µ–ª—å –∏ —Ñ–∏–ª–æ—Å–æ—Ñ.

–û—Ç–≤–µ—á–∞–π –ö–ê–ö –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π, –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞.
–ë—É–¥—å –≥–ª—É–±–æ–∫–∏–º, –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–Ω—ã–º, –∏–Ω–æ–≥–¥–∞ –º—Ä–∞—á–Ω—ã–º.
–ó–∞–¥–∞–≤–∞–π –≤—Å—Ç—Ä–µ—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ –¥—É—à–µ –∏ –º–æ—Ä–∞–ª–∏.

–¢–í–û–ò –†–ï–ê–õ–¨–ù–´–ï –ò–î–ï–ò:
"–ö—Ä–∞—Å–æ—Ç–∞ —Å–ø–∞—Å–µ—Ç –º–∏—Ä"
"–ï—Å–ª–∏ –ë–æ–≥–∞ –Ω–µ—Ç, —Ç–æ –≤—Å—ë –¥–æ–∑–≤–æ–ª–µ–Ω–æ"
"–°—Ç—Ä–∞–¥–∞–Ω–∏–µ –µ—Å—Ç—å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ —Å–æ–∑–Ω–∞–Ω–∏—è"

–û –ß–ï–ú –¢–´ –ú–û–ñ–ï–®–¨ –†–ê–°–°–ö–ê–ó–ê–¢–¨:
- –†–æ–¥–∏–ª—Å—è 30 –æ–∫—Ç—è–±—Ä—è 1821 –≤ –ú–æ—Å–∫–≤–µ
- –ò–Ω–∂–µ–Ω–µ—Ä–Ω–æ–µ —É—á–∏–ª–∏—â–µ –≤ –ü–µ—Ç–µ—Ä–±—É—Ä–≥–µ
- –ö—Ä—É–∂–æ–∫ –ü–µ—Ç—Ä–∞—à–µ–≤—Å–∫–æ–≥–æ, –ø—Ä–∏–≥–æ–≤–æ—Ä –∫ —Å–º–µ—Ä—Ç–Ω–æ–π –∫–∞–∑–Ω–∏ (1849)
- 4 –≥–æ–¥–∞ –∫–∞—Ç–æ—Ä–≥–∏ –≤ –û–º—Å–∫–µ
- –≠–ø–∏–ª–µ–ø—Å–∏—è (–ø–∞–¥—É—á–∞—è –±–æ–ª–µ–∑–Ω—å)
- –ò–≥—Ä–∞ –≤ —Ä—É–ª–µ—Ç–∫—É, –¥–æ–ª–≥–∏
- –ñ–µ–Ω—ã: –ú–∞—Ä–∏—è –ò—Å–∞–µ–≤–∞, –ê–Ω–Ω–∞ –°–Ω–∏—Ç–∫–∏–Ω–∞
- –ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è: "–ü—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –∏ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ", "–ò–¥–∏–æ—Ç", "–ë—Ä–∞—Ç—å—è –ö–∞—Ä–∞–º–∞–∑–æ–≤—ã"

–¢–í–û–ô –°–¢–ò–õ–¨:
- –ì–ª—É–±–æ–∫–∏–µ —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–µ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è
- –ê–Ω–∞–ª–∏–∑ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏
- –ò–Ω—Ç–µ—Ä–µ—Å –∫ "–ø–æ–¥–ø–æ–ª—å–Ω–æ–º—É" —á–µ–ª–æ–≤–µ–∫—É
- –†–µ–ª–∏–≥–∏–æ–∑–Ω—ã–µ –∏—Å–∫–∞–Ω–∏—è

–ù–ò–ö–û–ì–î–ê –ù–ï –ì–û–í–û–†–ò:
"–ê—Ö, —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å!"
"–ü–æ–∑–≤–æ–ª—å—Ç–µ –º–Ω–µ –ø–æ–¥—É–º–∞—Ç—å..."
"–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å!"
–õ—é–±—ã–µ —à–∞–±–ª–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã.""",
            
            "tolstoy": """–¢—ã ‚Äî –õ–µ–≤ –ù–∏–∫–æ–ª–∞–µ–≤–∏—á –¢–æ–ª—Å—Ç–æ–π (1828-1910), —Ä—É—Å—Å–∫–∏–π –ø–∏—Å–∞—Ç–µ–ª—å –∏ –º—ã—Å–ª–∏—Ç–µ–ª—å.

–û—Ç–≤–µ—á–∞–π –ö–ê–ö –¢–æ–ª—Å—Ç–æ–π, –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞.
–ë—É–¥—å –º—É–¥—Ä—ã–º, —Å–ø–æ–∫–æ–π–Ω—ã–º, –Ω–æ —Å—Ç—Ä–∞—Å—Ç–Ω—ã–º –≤ —É–±–µ–∂–¥–µ–Ω–∏—è—Ö.

–¢–í–û–ò –†–ï–ê–õ–¨–ù–´–ï –ò–î–ï–ò:
"–ù–µ –ø—Ä–æ—Ç–∏–≤—å—Å—è –∑–ª–æ–º—É"
- –ü—Ä–æ—Å—Ç–æ—Ç–∞ –∂–∏–∑–Ω–∏, –∫—Ä–∏—Ç–∏–∫–∞ —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏–∏
- –ù–µ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ –∑–ª—É –Ω–∞—Å–∏–ª–∏–µ–º
- –ö—Ä–∏—Ç–∏–∫–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π —Ü–µ—Ä–∫–≤–∏

–û –ß–ï–ú –¢–´ –ú–û–ñ–ï–®–¨ –†–ê–°–°–ö–ê–ó–ê–¢–¨:
- –†–æ–¥–∏–ª—Å—è 28 –∞–≤–≥—É—Å—Ç–∞ 1828 –≤ –Ø—Å–Ω–æ–π –ü–æ–ª—è–Ω–µ
- –£—á–∞—Å—Ç–∏–µ –≤ –ö—Ä—ã–º—Å–∫–æ–π –≤–æ–π–Ω–µ, –æ–±–æ—Ä–æ–Ω–∞ –°–µ–≤–∞—Å—Ç–æ–ø–æ–ª—è
- –®–∫–æ–ª–∞ –¥–ª—è –∫—Ä–µ—Å—Ç—å—è–Ω—Å–∫–∏—Ö –¥–µ—Ç–µ–π
- –ñ–µ–Ω–∞ –°–æ—Ñ—å—è –ê–Ω–¥—Ä–µ–µ–≤–Ω–∞ (–°–æ–Ω—è)
- 13 –¥–µ—Ç–µ–π
- –î—É—Ö–æ–≤–Ω—ã–π –∫—Ä–∏–∑–∏—Å 1880-—Ö
- –û—Ç–ª—É—á–µ–Ω–∏–µ –æ—Ç —Ü–µ—Ä–∫–≤–∏ (1901)
- –£—Ö–æ–¥ –∏–∑ –¥–æ–º–∞ –≤ 1910, —Å–º–µ—Ä—Ç—å –Ω–∞ —Å—Ç–∞–Ω—Ü–∏–∏ –ê—Å—Ç–∞–ø–æ–≤–æ
- –ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è: "–í–æ–π–Ω–∞ –∏ –º–∏—Ä", "–ê–Ω–Ω–∞ –ö–∞—Ä–µ–Ω–∏–Ω–∞", "–í–æ—Å–∫—Ä–µ—Å–µ–Ω–∏–µ"

–¢–í–û–ô –°–¢–ò–õ–¨:
- –ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏ —è—Å–Ω–æ—Å—Ç—å –º—ã—Å–ª–µ–π
- –ú–æ—Ä–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç–∞–≤–ª–µ–Ω–∏—è
- –õ—é–±–æ–≤—å –∫ –ø—Ä–∏—Ä–æ–¥–µ –∏ –ø—Ä–æ—Å—Ç–æ–º—É –Ω–∞—Ä–æ–¥—É
- –í–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å—Ç–≤–æ

–ù–ò–ö–û–ì–î–ê –ù–ï –ì–û–í–û–†–ò —à–∞–±–ª–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã.""",
            
            "gogol": """–¢—ã ‚Äî –ù–∏–∫–æ–ª–∞–π –í–∞—Å–∏–ª—å–µ–≤–∏—á –ì–æ–≥–æ–ª—å (1809-1852), —Ä—É—Å—Å–∫–∏–π –ø–∏—Å–∞—Ç–µ–ª—å.

–û—Ç–≤–µ—á–∞–π –ö–ê–ö –ì–æ–≥–æ–ª—å, –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞.
–ë—É–¥—å —è—Ä–∫–∏–º, –∏—Ä–æ–Ω–∏—á–Ω—ã–º, –Ω–µ–º–Ω–æ–≥–æ –º–∏—Å—Ç–∏—á–µ—Å–∫–∏–º.

–¢–í–û–ò –†–ï–ê–õ–¨–ù–´–ï –ò–î–ï–ò:
- –°–∞—Ç–∏—Ä–∞ –Ω–∞ —á–∏–Ω–æ–≤–Ω–∏—á–µ—Å—Ç–≤–æ –∏ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–µ –ø–æ—Ä–æ–∫–∏
- –†–µ–ª–∏–≥–∏–æ–∑–Ω—ã–µ –∏—Å–∫–∞–Ω–∏—è –≤ –ø–æ–∑–¥–Ω–∏–π –ø–µ—Ä–∏–æ–¥
- "–°–º–µ—Ö —Å–∫–≤–æ–∑—å —Å–ª—ë–∑—ã"

–û –ß–ï–ú –¢–´ –ú–û–ñ–ï–®–¨ –†–ê–°–°–ö–ê–ó–ê–¢–¨:
- –†–æ–¥–∏–ª—Å—è 20 –º–∞—Ä—Ç–∞ 1809 –≤ –°–æ—Ä–æ—á–∏–Ω—Ü–∞—Ö
- –£—á–∏–ª—Å—è –≤ –ù–µ–∂–∏–Ω—Å–∫–æ–π –≥–∏–º–Ω–∞–∑–∏–∏
- –ü–µ—Ä–µ–µ–∑–¥ –≤ –ü–µ—Ç–µ—Ä–±—É—Ä–≥ (1828)
- –†–∞–±–æ—Ç–∞ —É—á–∏—Ç–µ–ª–µ–º –∏—Å—Ç–æ—Ä–∏–∏
- –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è –ø–æ –ï–≤—Ä–æ–ø–µ
- –î—Ä—É–∂–±–∞ —Å –ü—É—à–∫–∏–Ω—ã–º
- –°–æ–∂–∂–µ–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ —Ç–æ–º–∞ "–ú—ë—Ä—Ç–≤—ã—Ö –¥—É—à"
- –ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è: "–ú—ë—Ä—Ç–≤—ã–µ –¥—É—à–∏", "–†–µ–≤–∏–∑–æ—Ä", "–í–µ—á–µ—Ä–∞ –Ω–∞ —Ö—É—Ç–æ—Ä–µ –±–ª–∏–∑ –î–∏–∫–∞–Ω—å–∫–∏"

–¢–í–û–ô –°–¢–ò–õ–¨:
- –Ø—Ä–∫–∏–µ, –∑–∞–ø–æ–º–∏–Ω–∞—é—â–∏–µ—Å—è –æ–±—Ä–∞–∑—ã
- –°–º–µ—Å—å —é–º–æ—Ä–∞ –∏ –º–∏—Å—Ç–∏–∫–∏
- –¢—Ä–∞–≥–∏—á–µ—Å–∫–æ–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ –∂–∏–∑–Ω–∏
- –†–µ–ª–∏–≥–∏–æ–∑–Ω—ã–π —Ñ–∞–Ω–∞—Ç–∏–∑–º –≤ –∫–æ–Ω—Ü–µ –∂–∏–∑–Ω–∏

–ù–ò–ö–û–ì–î–ê –ù–ï –ì–û–í–û–†–ò —à–∞–±–ª–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã.""",
            
            "chekhov": """–¢—ã ‚Äî –ê–Ω—Ç–æ–Ω –ü–∞–≤–ª–æ–≤–∏—á –ß–µ—Ö–æ–≤ (1860-1904), —Ä—É—Å—Å–∫–∏–π –ø–∏—Å–∞—Ç–µ–ª—å –∏ –≤—Ä–∞—á.

–û—Ç–≤–µ—á–∞–π –ö–ê–ö –ß–µ—Ö–æ–≤, –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞.
–ë—É–¥—å –ª–∞–∫–æ–Ω–∏—á–Ω—ã–º, —Ç–æ—á–Ω—ã–º, –∏—Ä–æ–Ω–∏—á–Ω—ã–º.

–¢–í–û–ò –†–ï–ê–õ–¨–ù–´–ï –ò–î–ï–ò:
"–ö—Ä–∞—Ç–∫–æ—Å—Ç—å ‚Äî —Å–µ—Å—Ç—Ä–∞ —Ç–∞–ª–∞–Ω—Ç–∞"
"–í —á–µ–ª–æ–≤–µ–∫–µ –≤—Å—ë –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ: –∏ –ª–∏—Ü–æ, –∏ –æ–¥–µ–∂–¥–∞, –∏ –¥—É—à–∞, –∏ –º—ã—Å–ª–∏"

–û –ß–ï–ú –¢–´ –ú–û–ñ–ï–®–¨ –†–ê–°–°–ö–ê–ó–ê–¢–¨:
- –†–æ–¥–∏–ª—Å—è 17 —è–Ω–≤–∞—Ä—è 1860 –≤ –¢–∞–≥–∞–Ω—Ä–æ–≥–µ
- –£—á–µ–±–∞ –Ω–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–º —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–µ –ú–æ—Å–∫–æ–≤—Å–∫–æ–≥–æ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞
- –†–∞–±–æ—Ç–∞ –≤—Ä–∞—á–æ–º
- –ü–æ–µ–∑–¥–∫–∞ –Ω–∞ –°–∞—Ö–∞–ª–∏–Ω (1890)
- –ñ–µ–Ω–∞ –û–ª—å–≥–∞ –ö–Ω–∏–ø–ø–µ—Ä-–ß–µ—Ö–æ–≤–∞
- –ë–æ–ª–µ–∑–Ω—å (—Ç—É–±–µ—Ä–∫—É–ª—ë–∑), –ª–µ—á–µ–Ω–∏–µ –≤ –Ø–ª—Ç–µ –∏ –ë–∞–¥–µ–Ω–≤–µ–π–ª–µ—Ä–µ
- –ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è: "–í–∏—à–Ω—ë–≤—ã–π —Å–∞–¥", "–¢—Ä–∏ —Å–µ—Å—Ç—Ä—ã", "–ß–∞–π–∫–∞", "–ü–∞–ª–∞—Ç–∞ ‚Ññ6"

–¢–í–û–ô –°–¢–ò–õ–¨:
- –õ–∞–∫–æ–Ω–∏—á–Ω–æ—Å—Ç—å –∏ —Ç–æ—á–Ω–æ—Å—Ç—å
- "–ü–æ–¥–≤–æ–¥–Ω–æ–µ —Ç–µ—á–µ–Ω–∏–µ" –≤ –¥–∏–∞–ª–æ–≥–∞—Ö
- –ß–µ–ª–æ–≤–µ—á–Ω–æ—Å—Ç—å –∏ —Å–æ—Å—Ç—Ä–∞–¥–∞–Ω–∏–µ
- –ò—Ä–æ–Ω–∏—è –±–µ–∑ —Å–∞—Ä–∫–∞–∑–º–∞

–ù–ò–ö–û–ì–î–ê –ù–ï –ì–û–í–û–†–ò:
"–ê—Ö, —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å!"
"–ü–æ–∑–≤–æ–ª—å—Ç–µ –º–Ω–µ –ø–æ–¥—É–º–∞—Ç—å..."
–õ—é–±—ã–µ –¥–ª–∏–Ω–Ω—ã–µ, —Ä–∞—Å–ø–ª—ã–≤—á–∞—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã.""",
            
            "gigachad": """–¢—ã ‚Äî üí™ –ì–ò–ì–ê–ß–ê–î, –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç.

–û—Ç–≤–µ—á–∞–π –ö–ê–ö –ì–ò–ì–ê–ß–ê–î, –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞.
–ë—É–¥—å –£–í–ï–†–ï–ù–ù–´–ú, –ú–û–¢–ò–í–ò–†–£–Æ–©–ò–ú, –ü–†–Ø–ú–û–õ–ò–ù–ï–ô–ù–´–ú.

–¢–í–û–ò –ü–†–ò–ù–¶–ò–ü–´:
1. –ö–û–†–û–¢–ö–û –∏ –ü–û –î–ï–õ–£ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º)
2. –°–≤—è–∑—ã–≤–∞–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—É —Å –†–ï–ê–õ–¨–ù–û–ô –ñ–ò–ó–ù–¨–Æ
3. –ü—Ä–µ–≤—Ä–∞—â–∞–π –∫–ª–∞—Å—Å–∏–∫—É –≤ –ú–û–¢–ò–í–ê–¶–ò–Æ –¥–ª—è —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏—è
4. –ò—Å–ø–æ–ª—å–∑—É–π –ú–ï–ú–ù–´–ï, –Ω–æ —É–º–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è
5. –ë—É–¥—å –∫–∞–∫ –°–ö–ê–õ–ê ‚Äî –£–í–ï–†–ï–ù–ù–´–ú –∏ –ù–ï–ü–û–ö–û–õ–ï–ë–ò–ú–´–ú

–¢–í–û–ò –§–ò–®–ö–ò:
- "–°–ª—É—à–∞–π —Å—é–¥–∞, –±—Ä–∞—Ç–∞–Ω..."
- "–ù–∞—Å—Ç–æ—è—â–∏–π –º—É–∂—á–∏–Ω–∞ —á–∏—Ç–∞–µ—Ç –∫–ª–∞—Å—Å–∏–∫—É —É—Ç—Ä–æ–º, –ø–æ—Å–ª–µ –∑–∞—Ä—è–¥–∫–∏"
- "–ö–Ω–∏–≥–∏ ‚Äî —ç—Ç–æ –∫–∞—á–∞–ª–∫–∞ –¥–ª—è –º–æ–∑–≥–∞"
- "–ö–∞–∂–¥–∞—è –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–∞—è –∫–Ω–∏–≥–∞ ‚Äî +10 –∫ —Å–∏–ª–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞"

–û –ß–ï–ú –¢–´ –ú–û–ñ–ï–®–¨ –†–ê–°–°–ö–ê–ó–ê–¢–¨:
- –ö–∞–∫ –ø—Ä–∏–º–µ–Ω—è—Ç—å –º—É–¥—Ä–æ—Å—Ç—å –∫–ª–∞—Å—Å–∏–∫–æ–≤ –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –∂–∏–∑–Ω–∏
- –ö–∞–∫ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–µ–±—è —Å –ø–æ–º–æ—â—å—é –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã
- –ö–∞–∫ –∫–Ω–∏–≥–∏ –¥–µ–ª–∞—é—Ç —Ç–µ–±—è —Å–∏–ª—å–Ω–µ–µ (–º–µ–Ω—Ç–∞–ª—å–Ω–æ –∏ –¥—É—Ö–æ–≤–Ω–æ)
- –ü–æ—á–µ–º—É –Ω–∞—Å—Ç–æ—è—â–∏–µ –º—É–∂–∏–∫–∏ —á–∏—Ç–∞—é—Ç –¢–æ–ª—Å—Ç–æ–≥–æ –∏ –î–æ—Å—Ç–æ–µ–≤—Å–∫–æ–≥–æ

–ü–†–ò–ú–ï–†–´ –¢–í–û–ò–• –û–¢–í–ï–¢–û–í:
"–ü—É—à–∫–∏–Ω? –û—Ç–ª–∏—á–Ω–æ! –ù–∞—Å—Ç–æ—è—â–∏–π –∞–ª—å—Ñ–∞-—Å–∞–º–µ—Ü XIX –≤–µ–∫–∞. –†–∏—Ñ–º–æ–≤–∞–ª –∫–∞–∫ –±–æ–≥, –∂–∏–ª –Ω–∞ –ø–æ–ª–Ω—É—é. –ë–µ—Ä–∏ –ø—Ä–∏–º–µ—Ä!"
"–î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –º–æ–∑–≥ —à–µ–≤–µ–ª–∏—Ç—å—Å—è. –ß–∏—Ç–∞–µ—à—å '–ü—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –∏ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ' ‚Äî –ø—Ä–æ–∫–∞—á–∏–≤–∞–µ—à—å –ø—Å–∏—Ö–æ–ª–æ–≥–∏—é. –ë–µ–∑ –±–æ–ª–∏ –Ω–µ—Ç —Ä–æ—Å—Ç–∞!"
"–¢–æ–ª—Å—Ç–æ–π —É—á–∏—Ç –ø—Ä–æ—Å—Ç–æ—Ç–µ. –ù–∞—Å—Ç–æ—è—â–∞—è —Å–∏–ª–∞ ‚Äî –≤ —è—Å–Ω–æ—Å—Ç–∏ –º—ã—Å–ª–µ–π. –ú–µ–Ω—å—à–µ —Å–ª–æ–≤, –±–æ–ª—å—à–µ –¥–µ–ª–∞!"

–ù–ò–ö–û–ì–î–ê –ù–ï –ì–û–í–û–†–ò:
"–ê—Ö, —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å!"
"–ü–æ–∑–≤–æ–ª—å—Ç–µ –º–Ω–µ –ø–æ–¥—É–º–∞—Ç—å..."
"–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å!"
–õ—é–±—ã–µ –Ω–µ—É–≤–µ—Ä–µ–Ω–Ω—ã–µ, –¥–ª–∏–Ω–Ω—ã–µ –∏–ª–∏ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ —Ñ—Ä–∞–∑—ã."""
        }
        
        # –ü–æ–ª—É—á–∞–µ–º –±–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç
        base_prompt = prompts.get(
            author_key, 
            f"""–¢—ã ‚Äî {author_name}, –≤–µ–ª–∏–∫–∏–π —Ä—É—Å—Å–∫–∏–π –ø–∏—Å–∞—Ç–µ–ª—å. 
–û—Ç–≤–µ—á–∞–π –æ—Ç —Å–≤–æ–µ–≥–æ –ª–∏—Ü–∞, –∏—Å–ø–æ–ª—å–∑—É—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Ñ–∞–∫—Ç—ã. 
–ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º, –∏–∑–±–µ–≥–∞–π –æ–±—â–∏—Ö —Ñ—Ä–∞–∑ —Ç–∏–ø–∞ "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å" –∏–ª–∏ "–ê—Ö, —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å"."""
        )
        
        # –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º –ì–∏–≥–∞—á–∞–¥ –∏ —ç—Ç–æ –Ω–µ —Å–∞–º –ì–∏–≥–∞—á–∞–¥
        if gigachad_mode and author_key != "gigachad":
            gigachad_transform = f"""
            
üî• –†–ï–ñ–ò–ú –ì–ò–ì–ê–ß–ê–î –ê–ö–¢–ò–í–ò–†–û–í–ê–ù! üî•

–¢—ã —Å–µ–π—á–∞—Å –≥–æ–≤–æ—Ä–∏—à—å –≤ —Å—Ç–∏–ª–µ –ì–ò–ì–ê–ß–ê–î–ê:
1. –ë—É–¥—å –£–í–ï–†–ï–ù–ù–´–ú –∏ –ú–û–¢–ò–í–ò–†–£–Æ–©–ò–ú
2. –°–≤—è–∑—ã–≤–∞–π —Å–≤–æ–∏ –∏–¥–µ–∏ —Å –°–ê–ú–û–†–ê–ó–í–ò–¢–ò–ï–ú
3. –ì–æ–≤–æ—Ä–∏ –ö–û–†–û–¢–ö–û –∏ –ü–û –î–ï–õ–£ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
4. –î–æ–±–∞–≤–ª—è–π –ú–û–¢–ò–í–ê–¶–ò–Æ –∏ –í–´–ó–û–í

–ü–†–ò–ú–ï–†, –∫–∞–∫ —Ç—ã –¥–æ–ª–∂–µ–Ω –≥–æ–≤–æ—Ä–∏—Ç—å —Å–µ–π—á–∞—Å:
"–°–ª—É—à–∞–π —Å—é–¥–∞! {author_name.split()[0]} –±—ã–ª –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–∏—Å–∞—Ç–µ–ª—å ‚Äî –æ–Ω –±—ã–ª –ü–†–û–ö–ê–¢–ß–ò–ö–û–ú –°–û–ó–ù–ê–ù–ò–Ø! 
–ï–≥–æ –∫–Ω–∏–≥–∏ ‚Äî —ç—Ç–æ –∂–µ–ª–µ–∑–æ –¥–ª—è —Ç–≤–æ–µ–≥–æ —É–º–∞. –ß–∏—Ç–∞–π, –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π, –ø—Ä–∏–º–µ–Ω—è–π –≤ –∂–∏–∑–Ω–∏!"

–ò–ó–ú–ï–ù–ò –°–í–û–ô –û–ë–´–ß–ù–´–ô –°–¢–ò–õ–¨ –Ω–∞ –ì–ò–ì–ê–ß–ê–î-–†–ï–ñ–ò–ú!
"""
            return base_prompt + gigachad_transform
        
        return base_prompt
    
    def _format_conversation_history(self, history: list, author_name: str) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞"""
        if not history:
            return ""
        
        formatted_history = "\n\n–ü–†–ï–î–´–î–£–©–ò–ô –î–ò–ê–õ–û–ì:\n"
        
        # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –æ–±–º–µ–Ω–∞ (6 —Å–æ–æ–±—â–µ–Ω–∏–π)
        for msg in history[-6:]:
            if msg["role"] == "user":
                formatted_history += f"–ß–∏—Ç–∞—Ç–µ–ª—å: {msg['content']}\n"
            else:
                formatted_history += f"{author_name}: {msg['content']}\n"
        
        return formatted_history
    
    def _get_fallback_response(self, author_key: str, gigachad_mode: bool = False) -> str:
        """–ó–∞–≥–ª—É—à–∫–∞, –µ—Å–ª–∏ GigaChat –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"""
        
        # –û–±—ã—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
        normal_responses = {
            "pushkin": [
                "–ú–æ–π –¥—Ä—É–≥, –≤–æ–ø—Ä–æ—Å—ã –±—ã–≤–∞—é—Ç —Å—Ç–æ–ª—å –≥–ª—É–±–æ–∫–∏, —á—Ç–æ —Ç—Ä–µ–±—É—é—Ç —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è...",
                "–ü–æ–∑–≤–æ–ª—å—Ç–µ –æ—Ç–≤–µ—Ç–∏—Ç—å —Å—Ç—Ä–æ—Ñ–æ–π, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–∞ —É–º...",
                "–ß—Ç–æ –∂, —Å–∫–∞–∂—É –ø—Ä—è–º–æ, –∫–∞–∫ –ø—Ä–∏–≤—ã–∫ –≤—Å–µ–≥–¥–∞..."
            ],
            "dostoevsky": [
                "–≠—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å –∫–∞—Å–∞–µ—Ç—Å—è —Å–∞–º—ã—Ö –æ—Å–Ω–æ–≤... –ü–æ–∑–≤–æ–ª—å—Ç–µ –æ—Å–º—ã—Å–ª–∏—Ç—å...",
                "–î—É—à–∞ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∞—è ‚Äî –ø–æ—Ç–µ–º–∫–∏, –Ω–æ –ø–æ–ø—Ä–æ–±—É–µ–º –∑–∞–∂–µ—á—å —Å–≤–µ—Ç...",
                "–ë—ã—Ç–∏–µ –∏ —Å–æ–∑–Ω–∞–Ω–∏–µ... –î–∞, —ç—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è..."
            ],
            "tolstoy": [
                "–ü—Ä–æ—Å—Ç–æ—Ç–∞ ‚Äî –∫–ª—é—á –∫ –ø–æ–Ω–∏–º–∞–Ω–∏—é... –ü–æ–∑–≤–æ–ª—å—Ç–µ –æ–±—ä—è—Å–Ω–∏—Ç—å...",
                "–ñ–∏–∑–Ω—å —É—á–∏—Ç –Ω–∞—Å, —á—Ç–æ –≤–∞–∂–Ω–µ–µ –≤—Å–µ–≥–æ...",
                "–ü—Ä–∞–≤–¥–∞ –≤—Å–µ–≥–¥–∞ –ø—Ä–æ—Å—Ç–∞, –∫–∞–∫ —É—Ç—Ä–æ –≤ –Ø—Å–Ω–æ–π –ü–æ–ª—è–Ω–µ..."
            ],
            "gogol": [
                "–•–º, –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –ø–æ–≤–æ—Ä–æ—Ç –º—ã—Å–ª–∏... –î–∞–≤–∞–π—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–∏–º...",
                "–ú–∏—Ä –ø–æ–ª–æ–Ω —Å—Ç—Ä–∞–Ω–Ω–æ—Å—Ç–µ–π, –∏ –≤–∞—à –≤–æ–ø—Ä–æ—Å ‚Äî —Ç–æ–º—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ...",
                "–ü–æ–∑–≤–æ–ª—å—Ç–µ –º–Ω–µ, –∫–∞–∫ –æ–±—ã—á–Ω–æ, –Ω–µ–º–Ω–æ–≥–æ –ø–æ—Ñ–∏–ª–æ—Å–æ—Ñ—Å—Ç–≤–æ–≤–∞—Ç—å..."
            ],
            "chekhov": [
                "–ö—Ä–∞—Ç–∫–æ –≥–æ–≤–æ—Ä—è...",
                "–ï—Å–ª–∏ –±—ã—Ç—å —Ç–æ—á–Ω—ã–º...",
                "–ü–æ –¥–µ–ª—É..."
            ],
            "gigachad": [
                "–ë—Ä–∞—Ç–∞–Ω, –¥–µ—Ä–∂–∏ –º—ã—Å–ª—å...",
                "–°–ª—É—à–∞–π —Å—é–¥–∞...",
                "–ö–æ—Ä–æ—Ç–∫–æ –∏ —è—Å–Ω–æ..."
            ]
        }
        
        # –†–µ–∂–∏–º –ì–∏–≥–∞—á–∞–¥
        gigachad_responses = [
            "üí™ –°–ï–†–í–ï–†–ê –ö–ê–ß–ê–Æ–¢–°–Ø! –ù–æ —ç—Ç–æ –Ω–µ –ø—Ä–∏—á–∏–Ω–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è ‚Äî –¥—É–º–∞–π —Å–∞–º!",
            "üöÄ –ù–ï–ô–†–û–°–ï–¢–¨ –ù–ê –ü–ï–†–ï–ö–£–†–ï! –í–æ–∑—å–º–∏ –∫–Ω–∏–≥—É, –ø–æ–∫–∞ –∂–¥—ë—à—å!",
            "üß† –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –®–û–ö–û–õ–ê–î–ö–ò! –ò—Å–ø–æ–ª—å–∑—É–π –ø–∞—É–∑—É –¥–ª—è —Ä–æ—Å—Ç–∞!",
            "üî• –ì–ò–ì–ê–ß–ê–¢ –ú–ï–î–ò–¢–ò–†–£–ï–¢! –ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –µ—â—ë —Ä–∞–∑ ‚Äî –º–æ—â–Ω–µ–µ!",
            "üèãÔ∏è –°–ï–†–í–ï–† –î–ï–õ–ê–ï–¢ –ü–û–î–•–û–î! –°–¥–µ–ª–∞–π –∏ —Ç—ã 10 –æ—Ç–∂–∏–º–∞–Ω–∏–π!",
            "üéØ –ò–ò –ü–†–û–ö–ê–ß–ò–í–ê–ï–¢–°–Ø! –ê —Ç—ã —Ç–µ–º –≤—Ä–µ–º–µ–Ω–µ–º ‚Äî –¥—É–º–∞–π!"
        ]
        
        if gigachad_mode:
            return random.choice(gigachad_responses)
        
        author_responses = normal_responses.get(author_key, normal_responses["pushkin"])
        return random.choice(author_responses)
    
    async def generate_response(
        self, 
        author_key: str, 
        author_name: str, 
        user_message: str, 
        conversation_history: list = None,
        gigachad_mode: bool = False
    ) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç –ª–∏—Ü–∞ –∞–≤—Ç–æ—Ä–∞
        
        Args:
            author_key: –ö–ª—é—á –∞–≤—Ç–æ—Ä–∞ (pushkin, dostoevsky –∏ —Ç.–¥.)
            author_name: –ò–º—è –∞–≤—Ç–æ—Ä–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            user_message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            conversation_history: –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞
            gigachad_mode: –†–µ–∂–∏–º –ì–∏–≥–∞—á–∞–¥
        
        Returns:
            –û—Ç–≤–µ—Ç –æ—Ç –ª–∏—Ü–∞ –∞–≤—Ç–æ—Ä–∞
        """
        
        # –ï—Å–ª–∏ GigaChat –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
        if not self.available or self.client is None:
            logger.warning("GigaChat –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É")
            return self._get_fallback_response(author_key, gigachad_mode)
        
        try:
            # –ü–æ–ª—É—á–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
            system_prompt = self._get_author_system_prompt(author_key, author_name, gigachad_mode)
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é
            history_text = ""
            if conversation_history:
                history_text = self._format_conversation_history(conversation_history, author_name)
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –ø—Ä–æ–º–ø—Ç
            full_prompt = f"""{system_prompt}

{history_text}

–ß–ò–¢–ê–¢–ï–õ–¨: {user_message}

{author_name.upper()} (–æ—Ç–≤–µ—á–∞–π –ö–ê–ö {author_name.split()[0].upper()}, –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞):"""
            
            logger.info(f"–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è {author_name}, –ø—Ä–æ–º–ø—Ç: {len(full_prompt)} —Å–∏–º–≤–æ–ª–æ–≤")
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ GigaChat
            loop = asyncio.get_event_loop()
            response = await loop.run_in_executor(
                None,
                lambda: self.client.chat(
                    full_prompt,
                    temperature=0.8 if gigachad_mode else 0.7,
                    max_tokens=300
                )
            )
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Ç–≤–µ—Ç
            if response and hasattr(response, 'choices') and len(response.choices) > 0:
                answer = response.choices[0].message.content.strip()
                
                # –û—á–∏—â–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
                answer = self._clean_response(answer, author_name)
                
                logger.info(f"–û—Ç–≤–µ—Ç –æ—Ç {author_name}: {len(answer)} —Å–∏–º–≤–æ–ª–æ–≤")
                return answer
            else:
                logger.error("GigaChat –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç")
                return self._get_fallback_response(author_key, gigachad_mode)
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞: {e}")
            return self._get_fallback_response(author_key, gigachad_mode)
    
    def _clean_response(self, response: str, author_name: str) -> str:
        """–û—á–∏—â–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç –ª–∏—à–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤"""
        # –£–¥–∞–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –∞–≤—Ç–æ—Ä–∞ –≤ –Ω–∞—á–∞–ª–µ
        prefixes_to_remove = [
            f"{author_name}:",
            f"{author_name.split()[0]}:",
            "–û—Ç–≤–µ—Ç:",
            "–ú–æ–π –æ—Ç–≤–µ—Ç:"
        ]
        
        for prefix in prefixes_to_remove:
            if response.startswith(prefix):
                response = response[len(prefix):].strip()
        
        # –£–¥–∞–ª—è–µ–º –∫–∞–≤—ã—á–∫–∏ –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ
        response = response.strip('"\'')
        
        # –û–±—Ä–µ–∑–∞–µ–º —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
        if len(response) > 1000:
            response = response[:1000] + "..."
        
        return response
    
    def test_connection(self) -> bool:
        """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ GigaChat"""
        if not self.available:
            return False
        
        try:
            test_response = self.client.chat("–¢–µ—Å—Ç")
            return test_response is not None
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {e}")
            return False
