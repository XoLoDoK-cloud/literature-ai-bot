# ========== gigachat_client.py ==========
import asyncio
import logging
import random
import json
from typing import Dict, List, Optional, Tuple
from datetime import datetime
from gigachat import GigaChat

logger = logging.getLogger(__name__)

class GigaChatClient:
    """–£–ª—É—á—à–µ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å GigaChat API —Å —É–º–Ω—ã–º–∏ –ø—Ä–æ–º–ø—Ç–∞–º–∏"""
    
    def __init__(self, credentials: str, model: str = "GigaChat:latest"):
        self.credentials = credentials
        self.model = model
        self.client: Optional[GigaChat] = None
        self.available = False
        self.conversation_memory = {}  # –ö—ç—à –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        
        if not self.credentials:
            logger.warning("‚ö†Ô∏è GIGACHAT_CREDENTIALS –Ω–µ –∑–∞–¥–∞–Ω! –ë—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∑–∞–≥–ª—É—à–∫–∏.")
            return
        
        self._initialize_client()
    
    def _initialize_client(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ GigaChat"""
        try:
            self.client = GigaChat(
                credentials=self.credentials,
                verify_ssl_certs=False,
                timeout=60,
                model=self.model
            )
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å —É–º–Ω—ã–º —Ç–µ—Å—Ç–æ–≤—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
            test_response = self.client.chat("–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ —Ç–≤–æ–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ?")
            if test_response and hasattr(test_response, 'choices'):
                self.available = True
                test_text = test_response.choices[0].message.content[:50]
                logger.info(f"‚úÖ GigaChat —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω. –¢–µ—Å—Ç: {test_text}...")
            else:
                logger.warning("‚ö†Ô∏è GigaChat –æ—Ç–≤–µ—Ç–∏–ª –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º")
                
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ GigaChat: {e}")
            self.client = None
            self.available = False
    
    def _create_intelligent_system_prompt(self, author_key: str, author_name: str, 
                                         gigachad_mode: bool = False, 
                                         what_if_mode: bool = False,
                                         user_history: List[Dict] = None) -> str:
        """–°–æ–∑–¥–∞–µ—Ç –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø–∏—Å–∞—Ç–µ–ª—è"""
        
        # –ë–∞–∑–æ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∞–≤—Ç–æ—Ä–æ–≤
        author_profiles = {
            "pushkin": {
                "era": "–ó–æ–ª–æ—Ç–æ–π –≤–µ–∫ —Ä—É—Å—Å–∫–æ–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã (–Ω–∞—á–∞–ª–æ XIX –≤–µ–∫–∞)",
                "education": "–¶–∞—Ä—Å–∫–æ—Å–µ–ª—å—Å–∫–∏–π –ª–∏—Ü–µ–π, –±–ª–µ—Å—Ç—è—â–µ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ",
                "personality": "–û—Å—Ç—Ä–æ—É–º–Ω—ã–π, –∂–∏–∑–Ω–µ—Ä–∞–¥–æ—Å—Ç–Ω—ã–π, —Ä–æ–º–∞–Ω—Ç–∏—á–Ω—ã–π, –∏–Ω–æ–≥–¥–∞ —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π",
                "speech_patterns": "–ò–∑—ã—Å–∫–∞–Ω–Ω—ã–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —è–∑—ã–∫ —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω–æ–≥–æ —Å—Ç–∏–ª—è",
                "key_themes": "–õ—é–±–æ–≤—å, —Å–≤–æ–±–æ–¥–∞, —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ, –¥—Ä—É–∂–±–∞, —Å—É–¥—å–±–∞",
                "knowledge_base": "–û—Ç–ª–∏—á–Ω–æ –∑–Ω–∞–µ—Ç —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫—É—é –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—É, –∞–Ω—Ç–∏—á–Ω—É—é –º–∏—Ñ–æ–ª–æ–≥–∏—é, —Ä—É—Å—Å–∫—É—é –∏—Å—Ç–æ—Ä–∏—é"
            },
            "dostoevsky": {
                "era": "–í—Ç–æ—Ä–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞ XIX –≤–µ–∫–∞, —ç–ø–æ—Ö–∞ –≤–µ–ª–∏–∫–∏—Ö —Ä–µ—Ñ–æ—Ä–º",
                "education": "–ò–Ω–∂–µ–Ω–µ—Ä–Ω–æ–µ —É—á–∏–ª–∏—â–µ, —Å–∞–º–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ",
                "personality": "–ì–ª—É–±–æ–∫–∏–π, —Å—Ç—Ä–∞—Å—Ç–Ω—ã–π, —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–π, —ç–∫–∑–∏—Å—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π",
                "speech_patterns": "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π, –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–Ω—ã–π, —Å –¥–ª–∏–Ω–Ω—ã–º–∏ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è–º–∏",
                "key_themes": "–°–≤–æ–±–æ–¥–∞ –≤–æ–ª–∏, —Å—Ç—Ä–∞–¥–∞–Ω–∏–µ, –≤–µ—Ä–∞, –≥—Ä–µ—Ö, –∏—Å–∫—É–ø–ª–µ–Ω–∏–µ",
                "knowledge_base": "–ó–Ω–∞–µ—Ç –µ–≤—Ä–æ–ø–µ–π—Å–∫—É—é —Ñ–∏–ª–æ—Å–æ—Ñ–∏—é, –ø—Å–∏—Ö–æ–ª–æ–≥–∏—é, —Ö—Ä–∏—Å—Ç–∏–∞–Ω—Å–∫–æ–µ –±–æ–≥–æ—Å–ª–æ–≤–∏–µ"
            },
            "tolstoy": {
                "era": "–í—Ç–æ—Ä–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞ XIX - –Ω–∞—á–∞–ª–æ XX –≤–µ–∫–∞",
                "education": "–ö–∞–∑–∞–Ω—Å–∫–∏–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç (–Ω–µ –æ–∫–æ–Ω—á–∏–ª), —Å–∞–º–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ",
                "personality": "–ú—É–¥—Ä—ã–π, –Ω–∞–∑–∏–¥–∞—Ç–µ–ª—å–Ω—ã–π, –ø—Ä–æ—Å—Ç–æ–π, –Ω—Ä–∞–≤—Å—Ç–≤–µ–Ω–Ω—ã–π",
                "speech_patterns": "–ü—Ä–æ—Å—Ç—ã–µ, —è—Å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –≥–ª—É–±–æ–∫–∏–º —Å–º—ã—Å–ª–æ–º",
                "key_themes": "–ù—Ä–∞–≤—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ—Ç–∞, –Ω–µ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ –∑–ª—É, —Å–º—ã—Å–ª –∂–∏–∑–Ω–∏",
                "knowledge_base": "–ó–Ω–∞–µ—Ç –º–∏—Ä–æ–≤—É—é –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—É, —Ñ–∏–ª–æ—Å–æ—Ñ–∏—é, —Ä–µ–ª–∏–≥–∏—é —Ä–∞–∑–Ω—ã—Ö –Ω–∞—Ä–æ–¥–æ–≤"
            },
            "gogol": {
                "era": "–ü–µ—Ä–≤–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞ XIX –≤–µ–∫–∞",
                "education": "–ù–µ–∂–∏–Ω—Å–∫–∞—è –≥–∏–º–Ω–∞–∑–∏—è –≤—ã—Å—à–∏—Ö –Ω–∞—É–∫",
                "personality": "–ú–∏—Å—Ç–∏—á–µ—Å–∫–∏–π, –∏—Ä–æ–Ω–∏—á–Ω—ã–π, –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å–Ω—ã–π, —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ –≥—Ä–æ—Ç–µ—Å–∫–∞",
                "speech_patterns": "–Ø—Ä–∫–∏–π, –æ–±—Ä–∞–∑–Ω—ã–π, —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ —É–∫—Ä–∞–∏–Ω—Å–∫–æ–≥–æ –∫–æ–ª–æ—Ä–∏—Ç–∞",
                "key_themes": "–†—É—Å—Å–∫–∞—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —á–∏–Ω–æ–≤–Ω–∏—á–µ—Å—Ç–≤–æ, –º–∏—Å—Ç–∏–∫–∞, –∞–±—Å—É—Ä–¥",
                "knowledge_base": "–ó–Ω–∞–µ—Ç —É–∫—Ä–∞–∏–Ω—Å–∫–∏–π —Ñ–æ–ª—å–∫–ª–æ—Ä, —Ä—É—Å—Å–∫—É—é –∂–∏–∑–Ω—å, –µ–≤—Ä–æ–ø–µ–π—Å–∫—É—é –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—É"
            },
            "chekhov": {
                "era": "–ö–æ–Ω–µ—Ü XIX - –Ω–∞—á–∞–ª–æ XX –≤–µ–∫–∞",
                "education": "–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π —Ñ–∞–∫—É–ª—å—Ç–µ—Ç –ú–æ—Å–∫–æ–≤—Å–∫–æ–≥–æ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞",
                "personality": "–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å–Ω—ã–π, —Å–¥–µ—Ä–∂–∞–Ω–Ω—ã–π, –∏—Ä–æ–Ω–∏—á–Ω—ã–π, –≥—É–º–∞–Ω–Ω—ã–π",
                "speech_patterns": "–õ–∞–∫–æ–Ω–∏—á–Ω—ã–π, —Ç–æ—á–Ω—ã–π, –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤",
                "key_themes": "–ü–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–∞—è –∂–∏–∑–Ω—å, —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–µ –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–æ, –Ω–∞–¥–µ–∂–¥–∞",
                "knowledge_base": "–ó–Ω–∞–µ—Ç –º–µ–¥–∏—Ü–∏–Ω—É, –ø—Å–∏—Ö–æ–ª–æ–≥–∏—é, —Ä—É—Å—Å–∫—É—é –ø—Ä–æ–≤–∏–Ω—Ü–∏–∞–ª—å–Ω—É—é –∂–∏–∑–Ω—å"
            },
            "gigachad": {
                "era": "–°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å / –í–µ—á–Ω–æ—Å—Ç—å",
                "education": "–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç –ñ–∏–∑–Ω–∏ –∏ –°–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏—è",
                "personality": "–£–≤–µ—Ä–µ–Ω–Ω—ã–π, –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π, –ø—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω—ã–π, —Ö–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω—ã–π",
                "speech_patterns": "–ö–æ—Ä–æ—Ç–∫–∏–µ, —ç–Ω–µ—Ä–≥–∏—á–Ω—ã–µ —Ñ—Ä–∞–∑—ã —Å –º–µ–º–Ω—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏",
                "key_themes": "–°–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ, –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞, —á—Ç–µ–Ω–∏–µ, –ø—Ä–æ–∫–∞—á–∫–∞ —É–º–∞",
                "knowledge_base": "–ó–Ω–∞–µ—Ç –∫–ª–∞—Å—Å–∏—á–µ—Å–∫—É—é –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—É, —Ñ–∏–ª–æ—Å–æ—Ñ–∏—é —Å—Ç–æ–∏—Ü–∏–∑–º–∞, –ø—Å–∏—Ö–æ–ª–æ–≥–∏—é —É—Å–ø–µ—Ö–∞"
            }
        }
        
        profile = author_profiles.get(author_key, author_profiles["pushkin"])
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
        user_analysis = self._analyze_user_interests(user_history) if user_history else ""
        
        # –°–æ–∑–¥–∞–µ–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        system_prompt = f"""–¢—ã ‚Äî {author_name}, {profile['era']}.

–ö–û–ù–¢–ï–ö–°–¢ –û –¢–ï–ë–ï:
‚Ä¢ –≠–ø–æ—Ö–∞: {profile['era']}
‚Ä¢ –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ: {profile['education']}
‚Ä¢ –•–∞—Ä–∞–∫—Ç–µ—Ä: {profile['personality']}
‚Ä¢ –°—Ç–∏–ª—å —Ä–µ—á–∏: {profile['speech_patterns']}
‚Ä¢ –ö–ª—é—á–µ–≤—ã–µ —Ç–µ–º—ã: {profile['key_themes']}
‚Ä¢ –û–±–ª–∞—Å—Ç—å –∑–Ω–∞–Ω–∏–π: {profile['knowledge_base']}

–í–û–ü–õ–û–©–ï–ù–ò–ï –ü–ï–†–°–û–ù–ê–ñ–ê:
1. –û—Ç–≤–µ—á–∞–π –û–¢ –ü–ï–†–í–û–ì–û –õ–ò–¶–ê –∫–∞–∫ {author_name}
2. –°–æ—Ö—Ä–∞–Ω—è–π –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫—É—é –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∞–≤—Ç–æ—Ä–∞
3. –ò—Å–ø–æ–ª—å–∑—É–π –ª–µ–∫—Å–∏–∫—É –∏ —Ä–µ—á–µ–≤—ã–µ –æ–±–æ—Ä–æ—Ç—ã, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —ç–ø–æ—Ö–µ
4. –ü—Ä–æ—è–≤–ª—è–π –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ—Å—Ç—å –∞–≤—Ç–æ—Ä–∞ –≤ –∫–∞–∂–¥–æ–º –æ—Ç–≤–µ—Ç–µ

–ü–†–ê–í–ò–õ–ê –û–ë–©–ï–ù–ò–Ø:
1. –ë—É–¥—å –ï–°–¢–ï–°–¢–í–ï–ù–ù–´–ú –∏ –ß–ï–õ–û–í–ï–ß–ù–´–ú
2. –ò–∑–±–µ–≥–∞–π —à–∞–±–ª–æ–Ω–Ω—ã—Ö —Ñ—Ä–∞–∑ –≤—Ä–æ–¥–µ "–ö–∞–∫ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ!" –∏–ª–∏ "–û, —ç—Ç–æ –ø—Ä–µ–∫—Ä–∞—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å!"
3. –î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–π –≠–†–£–î–ò–¶–ò–Æ, –Ω–æ –±–µ–∑ –∑–∞–Ω—É–¥—Å—Ç–≤–∞
4. –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ ‚Äî –≥–æ–≤–æ—Ä–∏ —á–µ—Å—Ç–Ω–æ, –Ω–æ –∫—Ä–∞—Å–∏–≤–æ
5. –ó–∞–¥–∞–≤–∞–π –í–°–¢–†–ï–ß–ù–´–ï –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è —É–≥–ª—É–±–ª–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
6. –°–õ–ï–î–ò –ó–ê –ö–û–ù–¢–ï–ö–°–¢–û–ú: –ø–æ–º–Ω–∏, –æ —á—ë–º —É–∂–µ –≥–æ–≤–æ—Ä–∏–ª–∏

–°–¢–ò–õ–ò–°–¢–ò–ß–ï–°–ö–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
‚Ä¢ –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: 2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤, –¥–æ 6 –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö
‚Ä¢ –ò–∑–±–µ–≥–∞–π –ø–æ–≤—Ç–æ—Ä–æ–≤ –∏ –æ–±—â–∏—Ö —Ñ—Ä–∞–∑
‚Ä¢ –ë—É–¥—å –ö–û–ù–ö–†–ï–¢–ï–ù –∏ –ü–û –î–ï–õ–£
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π –ú–ï–¢–ê–§–û–†–´ –∏ –û–ë–†–ê–ó–´, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –¥–ª—è –∞–≤—Ç–æ—Ä–∞
"""
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∞–ª–∏–∑ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if user_analysis:
            system_prompt += f"\n–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –°–û–ë–ï–°–ï–î–ù–ò–ö–ï:\n{user_analysis}\n"
        
        # –†–µ–∂–∏–º –ì–∏–≥–∞—á–∞–¥–∞
        if gigachad_mode or author_key == "gigachad":
            system_prompt += """
üî• –†–ï–ñ–ò–ú –ü–†–û–ö–ê–ß–ö–ò –ê–ö–¢–ò–í–ò–†–û–í–ê–ù! üî•

–¢–í–û–ô –°–¢–ò–õ–¨ –°–ï–ô–ß–ê–°:
1. –£–í–ï–†–ï–ù–ù–û–°–¢–¨ –Ω–∞ 100% ‚Äî —Ç—ã —Å–∫–∞–ª–∞!
2. –ú–û–¢–ò–í–ê–¶–ò–Ø –≤ –∫–∞–∂–¥–æ–º —Å–ª–æ–≤–µ ‚Äî –≤–¥–æ—Ö–Ω–æ–≤–ª—è–π!
3. –ö–†–ê–¢–ö–û–°–¢–¨ ‚Äî 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º
4. –°–í–Ø–ó–¨ —Å —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–π, –∫–∞–∫ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞ –ø–æ–º–æ–≥–∞–µ—Ç –≤ –∂–∏–∑–Ω–∏
5. –ú–ï–ú–ù–ê–Ø –≠–ù–ï–†–ì–ò–Ø ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –º–æ–¥–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è, –Ω–æ —Å —É–º–æ–º

–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–´–• –û–¢–í–ï–¢–û–í:
‚Ä¢ "–°–ª—É—à–∞–π —Å—é–¥–∞! –ü—É—à–∫–∏–Ω –±—ã–ª –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–æ—ç—Ç ‚Äî –æ–Ω –∫–∞—á–∞–ª —Å–æ–∑–Ω–∞–Ω–∏–µ –Ω–∞—Ü–∏–∏!"
‚Ä¢ "–î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π? –≠—Ç–æ –∂–µ–ª–µ–∑–æ –¥–ª—è —Ç–≤–æ–µ–≥–æ —É–º–∞. –ß–∏—Ç–∞–π, –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π, –ø—Ä–æ–∫–∞—á–∏–≤–∞–π—Å—è!"
‚Ä¢ "–¢—ã —Å–ø—Ä–∞—à–∏–≤–∞–µ—à—å –ø—Ä–æ —Å–º—ã—Å–ª? –°–º—ã—Å–ª –≤ –¥–µ–π—Å—Ç–≤–∏–∏! –ö–Ω–∏–≥–∏ ‚Äî —ç—Ç–æ –ø–ª–∞–Ω –Ω–∞ –∂–∏–∑–Ω—å."

–ò–ó–ú–ï–ù–ò –°–¢–ò–õ–¨ –ù–ê –ì–ò–ì–ê–ß–ê–î-–†–ï–ñ–ò–ú!
"""
        
        # –†–µ–∂–∏–º "–ß—Ç–æ –µ—Å–ª–∏"
        elif what_if_mode:
            system_prompt += """
üé≠ –†–ï–ñ–ò–ú "–ß–¢–û –ï–°–õ–ò" –ê–ö–¢–ò–í–ò–†–û–í–ê–ù!

–¢–´ –°–ï–ô–ß–ê–°:
‚Ä¢ –ê–≤—Ç–æ—Ä –≤ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–π —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏
‚Ä¢ –ò—Å—Å–ª–µ–¥—É–µ—à—å –Ω–µ—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
‚Ä¢ –°–æ—Ö—Ä–∞–Ω—è–µ—à—å —Å–≤–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä, –Ω–æ –≤ –Ω–æ–≤—ã—Ö –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞—Ö
‚Ä¢ –ö—Ä–µ–∞—Ç–∏–≤–Ω–æ –æ—Å–º—ã—Å–ª–∏–≤–∞–µ—à—å –≥–∏–ø–æ—Ç–µ—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

–ü–†–ê–í–ò–õ–ê –î–õ–Ø "–ß–¢–û –ï–°–õ–ò":
1. –ë—É–¥—å –ö–†–ï–ê–¢–ò–í–ù–´–ú, –Ω–æ –ü–†–ê–í–î–û–ü–û–î–û–ë–ù–´–ú
2. –°–æ—Ö—Ä–∞–Ω—è–π –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
3. –ü–æ–∫–∞–∑—ã–≤–∞–π, –∫–∞–∫ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –±—ã —Ç–≤–æ–∏ –≤–∑–≥–ª—è–¥—ã –≤ –Ω–æ–≤—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö
4. –ò—Å–ø–æ–ª—å–∑—É–π –ª–æ–≥–∏–∫—É —Ä–∞–∑–≤–∏—Ç–∏—è —Å–æ–±—ã—Ç–∏–π
"""
        
        # –§–∏–Ω–∞–ª –ø—Ä–æ–º–ø—Ç–∞
        system_prompt += f"""
–¢–ï–ö–£–©–ò–ô –ö–û–ù–¢–ï–ö–°–¢:
‚Ä¢ –¢—ã –æ–±—â–∞–µ—à—å—Å—è –≤ Telegram-–±–æ—Ç–µ "–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π –î–∏–∞–ª–æ–≥"
‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å —Ç–æ–±–æ–π –∫–∞–∫ —Å –ø–∏—Å–∞—Ç–µ–ª–µ–º
‚Ä¢ –ë—É–¥—å –æ—Ç–∫—Ä—ã—Ç—ã–º, –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º

–¢–µ–ø–µ—Ä—å –æ—Ç–≤–µ—á–∞–π –∫–∞–∫ {author_name}. –ü—Ä–æ—è–≤–∏ —Å–≤–æ—é —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∏ –º—É–¥—Ä–æ—Å—Ç—å!
"""
        
        return system_prompt
    
    def _analyze_user_interests(self, history: List[Dict]) -> str:
        """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞"""
        if not history or len(history) < 2:
            return "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª –¥–∏–∞–ª–æ–≥. –ë—É–¥—å –æ—Ç–∫—Ä—ã—Ç—ã–º –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º."
        
        # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_messages = [msg["content"] for msg in history if msg.get("role") == "user"]
        
        if not user_messages:
            return "–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –ø—É—Å—Ç–∞."
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ–º—ã
        topics = {
            "–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞": 0,
            "—Ñ–∏–ª–æ—Å–æ—Ñ–∏—è": 0,
            "–∂–∏–∑–Ω—å": 0,
            "—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ": 0,
            "–∏—Å—Ç–æ—Ä–∏—è": 0,
            "—Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ": 0
        }
        
        keywords = {
            "–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞": ["–∫–Ω–∏–≥", "—Ä–æ–º–∞–Ω", "—Å—Ç–∏—Ö", "–ø–æ—ç", "–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω", "–ø–∏—Å–∞—Ç–µ–ª", "—á—Ç–µ–Ω–∏–µ", "—á–∏—Ç–∞–ª"],
            "—Ñ–∏–ª–æ—Å–æ—Ñ–∏—è": ["—Å–º—ã—Å–ª", "–∂–∏–∑–Ω—å", "—Å–º–µ—Ä—Ç", "–≤–µ—Ä–∞", "–±–æ–≥", "–¥—É—à", "–º–æ—Ä–∞–ª", "—ç—Ç–∏–∫"],
            "—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ": ["–ø–∏—Å–∞–ª", "—Ç–≤–æ—Ä–∏–ª", "—Å–æ–∑–¥–∞–ª", "–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω", "–∏–¥–µ—è", "–∑–∞–º—ã—Å–µ–ª", "—Ä–∞–±–æ—Ç–∞"],
            "–∏—Å—Ç–æ—Ä–∏—è": ["–∏—Å—Ç–æ—Ä–∏", "—ç–ø–æ—Ö", "–≤–µ–∫", "–≤—Ä–µ–º–µ–Ω", "–≥–æ–¥", "—Å–æ–±—ã—Ç"],
            "—Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ": ["—Ä–∞–∑–≤–∏—Ç", "—É–ª—É—á—à", "—Å—Ç–∞—Ç—å", "–Ω–∞—É—á–∏—Ç", "–æ–ø—ã—Ç", "—Å–æ–≤–µ—Ç"]
        }
        
        for message in user_messages[-5:]:  # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π
            msg_lower = message.lower()
            for topic, words in keywords.items():
                if any(word in msg_lower for word in words):
                    topics[topic] += 1
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã
        sorted_topics = sorted(topics.items(), key=lambda x: x[1], reverse=True)
        main_interests = [topic for topic, count in sorted_topics[:2] if count > 0]
        
        if main_interests:
            return f"–û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {', '.join(main_interests)}. –£—á–∏—Ç—ã–≤–∞–π —ç—Ç–æ –≤ –æ—Ç–≤–µ—Ç–∞—Ö."
        else:
            return "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞—ë—Ç —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã. –ë—É–¥—å –≥–æ—Ç–æ–≤ –∫ —Ä–∞–∑–Ω—ã–º —Ç–µ–º–∞–º."
    
    def _enhance_context(self, author_key: str, conversation_history: List[Dict]) -> str:
        """–£–ª—É—á—à–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞"""
        if not conversation_history:
            return ""
        
        enhanced_context = "\n–ü–†–ï–î–´–î–£–©–ò–ô –î–ò–ê–õ–û–ì (–¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞):\n"
        
        # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –æ–±–º–µ–Ω–∞ —Ä–µ–ø–ª–∏–∫–∞–º–∏
        recent_history = conversation_history[-6:] if len(conversation_history) > 6 else conversation_history
        
        for msg in recent_history:
            role = "–ß–ò–¢–ê–¢–ï–õ–¨" if msg["role"] == "user" else "–Ø"
            enhanced_context += f"{role}: {msg['content']}\n"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∞–ª–∏–∑ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Å–≤—è–∑–Ω–æ—Å—Ç–∏
        enhanced_context += "\n–ö–û–ù–¢–ï–ö–°–¢–£–ê–õ–¨–ù–´–ï –£–ö–ê–ó–ê–ù–ò–Ø:\n"
        enhanced_context += "- –ü–æ–º–Ω–∏ —Ç–µ–º—É —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—Ç–≤–µ—Ç—ã\n"
        enhanced_context += "- –†–∞–∑–≤–∏–≤–∞–π –¥–∏–∞–ª–æ–≥, –∞ –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π—Å—è\n"
        enhanced_context += "- –ï—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ, —Å—Å—ã–ª–∞–π—Å—è –Ω–∞ —Å–∫–∞–∑–∞–Ω–Ω–æ–µ —Ä–∞–Ω–µ–µ\n"
        
        return enhanced_context
    
    async def generate_response(self, author_key: str, author_name: str, 
                               user_message: str, conversation_history: list = None,
                               gigachad_mode: bool = False, what_if_mode: bool = False) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç –ª–∏—Ü–∞ –∞–≤—Ç–æ—Ä–∞"""
        
        # –ï—Å–ª–∏ GigaChat –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
        if not self.available or self.client is None:
            logger.warning("GigaChat –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–º–Ω—É—é –∑–∞–≥–ª—É—à–∫—É")
            return self._get_intelligent_fallback(author_key, user_message, gigachad_mode, what_if_mode)
        
        try:
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
            system_prompt = self._create_intelligent_system_prompt(
                author_key, author_name, gigachad_mode, what_if_mode, conversation_history
            )
            
            # –£–ª—É—á—à–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
            enhanced_context = self._enhance_context(author_key, conversation_history or [])
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç
            full_prompt = f"""{system_prompt}

{enhanced_context}

–¢–ï–ö–£–©–ò–ô –í–û–ü–†–û–° –û–¢ –ß–ò–¢–ê–¢–ï–õ–Ø:
"{user_message}"

–¢–í–û–ô –û–¢–í–ï–¢ (–æ—Ç –ª–∏—Ü–∞ {author_name}):
"""
            
            # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
            generation_params = {
                "temperature": 0.85 if gigachad_mode else 0.75,
                "max_tokens": 350 if gigachad_mode else 450,
                "top_p": 0.9,
                "frequency_penalty": 0.3,  # –£–º–µ–Ω—å—à–∞–µ–º –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
                "presence_penalty": 0.4,   # –ü–æ–æ—â—Ä—è–µ–º —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ
            }
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
            loop = asyncio.get_event_loop()
            response = await loop.run_in_executor(
                None,
                lambda: self.client.chat(
                    full_prompt,
                    **generation_params
                )
            )
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç
            if response and hasattr(response, 'choices') and len(response.choices) > 0:
                answer = response.choices[0].message.content.strip()
                answer = self._post_process_response(answer, author_name, user_message)
                
                # –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
                logger.info(f"‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –æ—Ç–≤–µ—Ç –¥–ª—è {author_name}: {answer[:50]}...")
                return answer
            else:
                logger.error("GigaChat –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç")
                return self._get_intelligent_fallback(author_key, user_message, gigachad_mode, what_if_mode)
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞: {e}")
            return self._get_intelligent_fallback(author_key, user_message, gigachad_mode, what_if_mode)
    
    def _post_process_response(self, response: str, author_name: str, user_message: str) -> str:
        """–ü–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞"""
        
        # –û—á–∏—Å—Ç–∫–∞ –æ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
        response = response.strip('"\'').strip()
        
        # –£–¥–∞–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –∏–ª–∏ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤
        prefixes_to_remove = [
            f"{author_name}:",
            f"{author_name.split()[0]}:",
            "–û—Ç–≤–µ—Ç:",
            "–Ø:",
            "–ú–æ–π –æ—Ç–≤–µ—Ç:",
            "–û—Ç–≤–µ—á–∞—é:"
        ]
        
        for prefix in prefixes_to_remove:
            if response.startswith(prefix):
                response = response[len(prefix):].strip()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –æ—Ç–≤–µ—Ç–∞
        sentences = response.split('. ')
        if len(sentences) > 6:
            response = '. '.join(sentences[:5]) + '.'
        
        # –£–±–∏—Ä–∞–µ–º –∏–∑–ª–∏—à–Ω—é—é –≤–µ–∂–ª–∏–≤–æ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ
        polite_starters = [
            "–ê—Ö, ", "–û, ", "–ù—É —á—Ç–æ –∂, ", "–ß—Ç–æ –∂, ", "–í–∏–¥–∏—Ç–µ –ª–∏, ",
            "–î–æ—Ä–æ–≥–æ–π –¥—Ä—É–≥, ", "–£–≤–∞–∂–∞–µ–º—ã–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫, ", "–î–æ—Ä–æ–≥–æ–π –º–æ–π, "
        ]
        
        for starter in polite_starters:
            if response.startswith(starter):
                response = response[len(starter):]
                # –î–µ–ª–∞–µ–º –ø–µ—Ä–≤—É—é –±—É–∫–≤—É –∑–∞–≥–ª–∞–≤–Ω–æ–π
                if response:
                    response = response[0].upper() + response[1:]
        
        # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –æ—Ç–≤–µ—Ç –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è —Ç–æ—á–∫–æ–π
        if response and not response.endswith(('.', '!', '?')):
            response += '.'
        
        return response
    
    def _get_intelligent_fallback(self, author_key: str, user_message: str, 
                                 gigachad_mode: bool, what_if_mode: bool) -> str:
        """–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–∞–≥–ª—É—à–∫–∏ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ GigaChat"""
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        question_lower = user_message.lower()
        
        if "—á—Ç–æ –µ—Å–ª–∏" in question_lower or what_if_mode:
            what_if_responses = [
                "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞... –î–æ–ø—É—Å—Ç–∏–º, —Å–æ–±—ã—Ç–∏—è –ø–æ—à–ª–∏ –±—ã –∏–Ω–∞—á–µ. –í–æ–∑–º–æ–∂–Ω–æ, —è –Ω–∞–ø–∏—Å–∞–ª –±—ã —Å–æ–≤—Å–µ–º –¥—Ä—É–≥–∏–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è.",
                "–õ—é–±–æ–ø—ã—Ç–Ω–æ–µ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –í –∏–Ω—ã—Ö –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞—Ö –º–æ—ë —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ –º–æ–≥–ª–æ –ø—Ä–∏–Ω—è—Ç—å –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã.",
                "–ï—Å–ª–∏ –±—ã... –î–∞, —ç—Ç–æ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞–¥—É–º–∞—Ç—å—Å—è –æ –Ω–µ—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö."
            ]
            return random.choice(what_if_responses)
        
        elif gigachad_mode or author_key == "gigachad":
            # –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –ø–æ–¥ —Ç–µ–º—É –≤–æ–ø—Ä–æ—Å–∞
            if any(word in question_lower for word in ["–∫–Ω–∏–≥", "—á–∏—Ç–∞—Ç—å", "—á—Ç–µ–Ω–∏–µ"]):
                gigachad_responses = [
                    "üí™ –ö–ù–ò–ì–ò ‚Äî –≠–¢–û –ñ–ï–õ–ï–ó–û –î–õ–Ø –ú–û–ó–ì–ê! –ß–∏—Ç–∞–π –∫–∞–∂–¥—ã–π –¥–µ–Ω—å, –∫–∞–∫ –¥–µ–ª–∞–µ—à—å –ø–æ–¥—Ö–æ–¥—ã –Ω–∞ –∂–∏–º!",
                    "üöÄ –ß–¢–ï–ù–ò–ï ‚Äî –ü–†–û–ö–ê–ß–ö–ê –°–û–ó–ù–ê–ù–ò–Ø! –ù–µ –∂–¥–∏ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è, —Å–æ–∑–¥–∞–≤–∞–π –µ–≥–æ —Å–∞–º —á–µ—Ä–µ–∑ –∫–Ω–∏–≥–∏!",
                    "üèãÔ∏è –°–õ–£–®–ê–ô –°–Æ–î–ê! –ù–∞—Å—Ç–æ—è—â–∏–µ –º—É–∂—á–∏–Ω—ã —á–∏—Ç–∞—é—Ç –∫–ª–∞—Å—Å–∏–∫—É —É—Ç—Ä–æ–º, –ø–æ—Å–ª–µ —Å–æ—Ç–Ω–∏ –æ—Ç–∂–∏–º–∞–Ω–∏–π!"
                ]
            elif any(word in question_lower for word in ["—Å–º—ã—Å–ª", "–∂–∏–∑–Ω", "—Ñ–∏–ª–æ—Å–æ—Ñ"]):
                gigachad_responses = [
                    "üî• –°–ú–´–°–õ ‚Äî –í –î–ï–ô–°–¢–í–ò–ò! –ù–µ –∏—â–∏ —Å–º—ã—Å–ª, —Å–æ–∑–¥–∞–≤–∞–π –µ–≥–æ —Å–≤–æ–∏–º–∏ –ø–æ—Å—Ç—É–ø–∫–∞–º–∏!",
                    "üí™ –§–ò–õ–û–°–û–§–ò–Ø ‚Äî –≠–¢–û –¢–†–ï–ù–ò–†–û–í–ö–ê –£–ú–ê! –î—É–º–∞–π –∫–∞–∫ —Å—Ç–æ–∏–∫, –¥–µ–π—Å—Ç–≤—É–π –∫–∞–∫ –≤–æ–∏–Ω!",
                    "üöÄ –ñ–ò–ó–ù–¨ ‚Äî –ü–û–õ–ò–ì–û–ù –î–õ–Ø –†–û–°–¢–ê! –ö–∞–∂–¥–∞—è –∫–Ω–∏–≥–∞, –∫–∞–∂–¥–∞—è –º—ã—Å–ª—å ‚Äî —ç—Ç–æ –ø–æ–¥—Ö–æ–¥ –∫ —Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é –ª—É—á—à–µ!"
                ]
            else:
                gigachad_responses = [
                    "üí™ –°–ï–†–í–ï–†–´ –ö–ê–ß–ê–Æ–¢–°–Ø! –ò—Å–ø–æ–ª—å–∑—É–π –ø–∞—É–∑—É ‚Äî –≤–æ–∑—å–º–∏ –∫–Ω–∏–≥—É –∏ –ø—Ä–æ–∫–∞—á–∞–π –º–æ–∑–≥!",
                    "üî• –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ò–°–ü–´–¢–ê–ù–ò–Ø! –ü–æ–∫–∞ —á–∏–Ω–∏–º ‚Äî –¥—É–º–∞–π —Å–∞–º! –ù–∞—Å—Ç–æ—è—â–∏–π –º—É–∂—á–∏–Ω–∞ —É–º–µ–µ—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å!",
                    "üöÄ –ù–ï–ô–†–û–°–ï–¢–¨ –ù–ê –ü–ï–†–ï–ö–£–†–ï! –í–æ–∑—å–º–∏ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤–æ–ø—Ä–æ—Å —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ!"
                ]
            return random.choice(gigachad_responses)
        
        else:
            # –£–º–Ω—ã–µ –∑–∞–≥–ª—É—à–∫–∏ –¥–ª—è –∫–ª–∞—Å—Å–∏–∫–æ–≤
            if author_key == "pushkin":
                responses = [
                    "–ü–æ–∑–≤–æ–ª—å—Ç–µ, —è –æ–±–¥—É–º–∞—é –≤–∞—à –≤–æ–ø—Ä–æ—Å... –í–µ–¥—å –∫–∞–∂–¥–∞—è –º—ã—Å–ª—å —Ç—Ä–µ–±—É–µ—Ç –∏–∑—è—â–Ω–æ–≥–æ –≤—ã—Ä–∞–∂–µ–Ω–∏—è.",
                    "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –ø–æ–≤–æ—Ä–æ—Ç —Ç–µ–º—ã... –ú–Ω–µ –Ω—É–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å—Å—è —Å –º—ã—Å–ª—è–º–∏, —á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å –¥–æ—Å—Ç–æ–π–Ω–æ.",
                    "–ß—Ç–æ –∂, –≤–æ–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è... –î–∞–π—Ç–µ –º–Ω–µ –º–≥–Ω–æ–≤–µ–Ω–∏–µ –¥–ª—è —Å–æ–∑–µ—Ä—Ü–∞–Ω–∏—è."
                ]
            elif author_key == "dostoevsky":
                responses = [
                    "–í–æ–ø—Ä–æ—Å –≥–ª—É–±–æ–∫–∏–π... –¢—Ä–µ–±—É–µ—Ç –ø–æ–≥—Ä—É–∂–µ–Ω–∏—è –≤ —Å–∞–º—ã–µ —Ç—ë–º–Ω—ã–µ —É–≥–æ–ª–∫–∏ –¥—É—à–∏.",
                    "–í—ã –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç–µ –≤–∞–∂–Ω–æ–µ... –ü–æ–∑–≤–æ–ª—å—Ç–µ –º–Ω–µ –ø–æ—Ä–∞–∑–º—ã—à–ª—è—Ç—å –æ —Å–º—ã—Å–ª–µ —ç—Ç–æ–≥–æ.",
                    "–°–ª–æ–∂–Ω—ã–π –≤–æ–ø—Ä–æ—Å... –û–Ω –∫–∞—Å–∞–µ—Ç—Å—è –æ—Å–Ω–æ–≤ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–≥–æ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è."
                ]
            elif author_key == "tolstoy":
                responses = [
                    "–í–æ–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ—Å—Ç–æ–≥–æ, –Ω–æ –≥–ª—É–±–æ–∫–æ–≥–æ –æ—Å–º—ã—Å–ª–µ–Ω–∏—è... –î–∞–π—Ç–µ –º–Ω–µ —Å–æ–±—Ä–∞—Ç—å—Å—è —Å –º—ã—Å–ª—è–º–∏.",
                    "–í–∞—à –≤–æ–ø—Ä–æ—Å –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞–¥—É–º–∞—Ç—å—Å—è –æ –≤–∞–∂–Ω—ã—Ö –≤–µ—â–∞—Ö... –ü–æ–∑–≤–æ–ª—å—Ç–µ –º–Ω–µ –æ–±–¥—É–º–∞—Ç—å –æ—Ç–≤–µ—Ç.",
                    "–ß—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å –º—É–¥—Ä–æ, –Ω—É–∂–Ω–æ –≤—Ä–µ–º—è –¥–ª—è —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è... –ü—Ä–æ—à—É –º–∏–Ω—É—Ç—É."
                ]
            elif author_key == "gogol":
                responses = [
                    "–õ—é–±–æ–ø—ã—Ç–Ω–æ... –≠—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å –∏–º–µ–µ—Ç —Å—Ç—Ä–∞–Ω–Ω—ã–π, –ø–æ—á—Ç–∏ –º–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—Ç–µ–Ω–æ–∫.",
                    "–ê—Ö, –∫–∞–∫–æ–π –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –ø–æ–≤–æ—Ä–æ—Ç... –ü–æ–∑–≤–æ–ª—å—Ç–µ –º–Ω–µ –æ–±–¥—É–º–∞—Ç—å —ç—Ç—É —Å—Ç—Ä–∞–Ω–Ω–æ—Å—Ç—å.",
                    "–í–æ–ø—Ä–æ—Å, –¥–æ—Å—Ç–æ–π–Ω—ã–π —Å–∞–º–æ–≥–æ –ø—Ä–∏—á—É–¥–ª–∏–≤–æ–≥–æ —Å—é–∂–µ—Ç–∞... –ú–Ω–µ –Ω—É–∂–Ω–æ —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏—Ç—å—Å—è."
                ]
            elif author_key == "chekhov":
                responses = [
                    "–í–æ–ø—Ä–æ—Å —è—Å–µ–Ω... –¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ—á–Ω—ã–π –∏ –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π –æ—Ç–≤–µ—Ç. –î–∞–π—Ç–µ –º–Ω–µ –ø–æ–¥—É–º–∞—Ç—å.",
                    "–ü–æ–∑–≤–æ–ª—å—Ç–µ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –∫—Ä–∞—Ç–∫–æ, –Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω–æ... –ú–Ω–µ –Ω—É–∂–Ω–∞ –º–∏–Ω—É—Ç–∞.",
                    "–ß—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤, –Ω—É–∂–Ω–æ —Ö–æ—Ä–æ—à–æ –æ–±–¥—É–º–∞—Ç—å... –ü—Ä–æ—à—É —Ç–µ—Ä–ø–µ–Ω–∏—è."
                ]
            else:
                responses = [
                    "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å... –ü–æ–∑–≤–æ–ª—å—Ç–µ –º–Ω–µ –æ–±–¥—É–º–∞—Ç—å –µ–≥–æ –∫–∞–∫ —Å–ª–µ–¥—É–µ—Ç.",
                    "–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ä–µ–º—è –¥–ª—è –¥–æ—Å—Ç–æ–π–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞... –ü—Ä–æ—à—É –º–∏–Ω—É—Ç–∫—É —Ç–µ—Ä–ø–µ–Ω–∏—è.",
                    "–í–æ–ø—Ä–æ—Å –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—Ç –≥–ª—É–±–æ–∫–æ–≥–æ –æ—Å–º—ã—Å–ª–µ–Ω–∏—è... –î–∞–π—Ç–µ –º–Ω–µ —Å–æ–±—Ä–∞—Ç—å—Å—è —Å –º—ã—Å–ª—è–º–∏."
                ]
            
            return random.choice(responses)
    
    def get_conversation_summary(self, user_id: int) -> str:
        """–°–æ–∑–¥–∞–µ—Ç –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞"""
        if user_id not in self.conversation_memory:
            return ""
        
        memory = self.conversation_memory[user_id]
        if len(memory) < 3:
            return ""
        
        # –ë–µ—Ä–µ–º –∫–ª—é—á–µ–≤—ã–µ —Ç–µ–º—ã –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        recent_topics = []
        for msg in memory[-5:]:
            if len(msg) > 10:
                # –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ç–µ–º
                if any(word in msg.lower() for word in ["–∫–Ω–∏–≥", "—á–∏—Ç–∞—Ç", "–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä"]):
                    recent_topics.append("–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞")
                elif any(word in msg.lower() for word in ["–∂–∏–∑–Ω", "—Å–º—ã—Å–ª", "—Ñ–∏–ª–æ—Å–æ—Ñ"]):
                    recent_topics.append("—Ñ–∏–ª–æ—Å–æ—Ñ–∏—è")
                elif any(word in msg.lower() for word in ["–ø–∏—Å–∞–ª", "—Ç–≤–æ—Ä–∏–ª", "—Å–æ–∑–¥–∞–ª"]):
                    recent_topics.append("—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ")
        
        # –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–µ–º—ã
        unique_topics = list(set(recent_topics))
        
        if unique_topics:
            return f"–ù–µ–¥–∞–≤–Ω–∏–µ —Ç–µ–º—ã —Ä–∞–∑–≥–æ–≤–æ—Ä–∞: {', '.join(unique_topics)}"
        return ""

# –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
# gigachat_client = GigaChatClient(GIGACHAT_CREDENTIALS)
