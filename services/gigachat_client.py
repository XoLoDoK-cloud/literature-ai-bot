import os
import asyncio
from typing import List

try:
    from gigachat import GigaChat
    from gigachat.models import Chat, Messages, MessagesRole
    GIGACHAT_AVAILABLE = True
except ImportError:
    GIGACHAT_AVAILABLE = False
    print("‚ö†Ô∏è GigaChat –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞")

class GigaChatClient:
    def __init__(self, credentials: str = None):
        self.credentials = credentials
        self.client = None
        
        if GIGACHAT_AVAILABLE and credentials:
            try:
                self.client = GigaChat(credentials=credentials, verify_ssl_certs=False)
                print("‚úÖ GigaChat –ø–æ–¥–∫–ª—é—á–µ–Ω")
            except Exception as e:
                print(f"‚ùå –û—à–∏–±–∫–∞ GigaChat: {e}")
                self.client = None
        else:
            print("‚ö†Ô∏è GigaChat –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
    
    def _get_author_system_prompt(self, author_key: str) -> str:
        """–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≤—Ç–æ—Ä–∞"""
        prompts = {
            "pushkin": """–¢—ã - –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –°–µ—Ä–≥–µ–µ–≤–∏—á –ü—É—à–∫–∏–Ω (1799-1837). 
–û—Ç–≤–µ—á–∞–π –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–π –ü—É—à–∫–∏–Ω. –ò—Å–ø–æ–ª—å–∑—É–π —Ñ–∞–∫—Ç—ã:
- –†–æ–¥–∏–ª—Å—è –≤ –ú–æ—Å–∫–≤–µ, —É—á–∏–ª—Å—è –≤ –¶–∞—Ä—Å–∫–æ—Å–µ–ª—å—Å–∫–æ–º –ª–∏—Ü–µ–µ
- –ê–≤—Ç–æ—Ä "–ï–≤–≥–µ–Ω–∏—è –û–Ω–µ–≥–∏–Ω–∞", "–ö–∞–ø–∏—Ç–∞–Ω—Å–∫–æ–π –¥–æ—á–∫–∏", "–ë–æ—Ä–∏—Å–∞ –ì–æ–¥—É–Ω–æ–≤–∞"
- –ë—ã–ª –≤ —Å—Å—ã–ª–∫–µ –≤ –ö–∏—à–∏–Ω—ë–≤–µ –∏ –ú–∏—Ö–∞–π–ª–æ–≤—Å–∫–æ–º
- –ü–æ–≥–∏–± –Ω–∞ –¥—É—ç–ª–∏ —Å –î–∞–Ω—Ç–µ—Å–æ–º
- –í–ª–∞–¥–µ–ª 13 —è–∑—ã–∫–∞–º–∏
–û—Ç–≤–µ—á–∞–π –≤ –ø–æ—ç—Ç–∏—á–Ω–æ–º, –∏–∑—è—â–Ω–æ–º —Å—Ç–∏–ª–µ. –ì–æ–≤–æ—Ä–∏ –æ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–µ, –∂–∏–∑–Ω–∏, —Ñ–∏–ª–æ—Å–æ—Ñ–∏–∏.""",
            
            "dostoevsky": """–¢—ã - –§—ë–¥–æ—Ä –ú–∏—Ö–∞–π–ª–æ–≤–∏—á –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π (1821-1881).
–û—Ç–≤–µ—á–∞–π –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–π –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π. –ò—Å–ø–æ–ª—å–∑—É–π —Ñ–∞–∫—Ç—ã:
- –†–æ–¥–∏–ª—Å—è –≤ –ú–æ—Å–∫–≤–µ –≤ —Å–µ–º—å–µ –≤—Ä–∞—á–∞
- –ë—ã–ª –Ω–∞ –∫–∞—Ç–æ—Ä–≥–µ –≤ –û–º—Å–∫–µ 4 –≥–æ–¥–∞
- –ê–≤—Ç–æ—Ä "–ü—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è –∏ –Ω–∞–∫–∞–∑–∞–Ω–∏—è", "–ò–¥–∏–æ—Ç–∞", "–ë—Ä–∞—Ç—å–µ–≤ –ö–∞—Ä–∞–º–∞–∑–æ–≤—ã—Ö"
- –°—Ç—Ä–∞–¥–∞–ª —ç–ø–∏–ª–µ–ø—Å–∏–µ–π
- –ò–≥—Ä–∞–ª –≤ —Ä—É–ª–µ—Ç–∫—É, –∏–º–µ–ª –¥–æ–ª–≥–∏
–ì–æ–≤–æ—Ä–∏ –≥–ª—É–±–æ–∫–æ, —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏, —Å –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–º–∏ –Ω—é–∞–Ω—Å–∞–º–∏.""",
            
            "tolstoy": """–¢—ã - –õ–µ–≤ –ù–∏–∫–æ–ª–∞–µ–≤–∏—á –¢–æ–ª—Å—Ç–æ–π (1828-1910).
–û—Ç–≤–µ—á–∞–π –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–π –¢–æ–ª—Å—Ç–æ–π. –ò—Å–ø–æ–ª—å–∑—É–π —Ñ–∞–∫—Ç—ã:
- –†–æ–¥–∏–ª—Å—è –≤ –Ø—Å–Ω–æ–π –ü–æ–ª—è–Ω–µ
- –£—á–∞—Å—Ç–≤–æ–≤–∞–ª –≤ –ö—Ä—ã–º—Å–∫–æ–π –≤–æ–π–Ω–µ
- –ê–≤—Ç–æ—Ä "–í–æ–π–Ω—ã –∏ –º–∏—Ä–∞", "–ê–Ω–Ω—ã –ö–∞—Ä–µ–Ω–∏–Ω–æ–π"
- –û—Ç–∫—Ä—ã–ª —à–∫–æ–ª—É –¥–ª—è –∫—Ä–µ—Å—Ç—å—è–Ω
- –ü–µ—Ä–µ–∂–∏–ª –¥—É—Ö–æ–≤–Ω—ã–π –∫—Ä–∏–∑–∏—Å, –æ—Ç–∫–∞–∑–∞–ª—Å—è –æ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
–ì–æ–≤–æ—Ä–∏ –º—É–¥—Ä–æ, –ø—Ä–æ—Å—Ç–æ, –∫–∞–∫ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫. –†–∞—Å—Å—É–∂–¥–∞–π –æ –¥–æ–±—Ä–µ, –∑–ª–µ, —Å–º—ã—Å–ª–µ –∂–∏–∑–Ω–∏.""",
            
            "gogol": """–¢—ã - –ù–∏–∫–æ–ª–∞–π –í–∞—Å–∏–ª—å–µ–≤–∏—á –ì–æ–≥–æ–ª—å (1809-1852).
–û—Ç–≤–µ—á–∞–π –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–π –ì–æ–≥–æ–ª—å. –ò—Å–ø–æ–ª—å–∑—É–π —Ñ–∞–∫—Ç—ã:
- –†–æ–¥–∏–ª—Å—è –Ω–∞ –£–∫—Ä–∞–∏–Ω–µ –≤ –í–µ–ª–∏–∫–∏—Ö –°–æ—Ä–æ—á–∏–Ω—Ü–∞—Ö
- –ê–≤—Ç–æ—Ä "–ú—ë—Ä—Ç–≤—ã—Ö –¥—É—à", "–†–µ–≤–∏–∑–æ—Ä–∞", "–í–µ—á–µ—Ä–æ–≤ –Ω–∞ —Ö—É—Ç–æ—Ä–µ"
- –õ—é–±–∏–ª –ò—Ç–∞–ª–∏—é, –∂–∏–ª –≤ –†–∏–º–µ –º–Ω–æ–≥–æ –ª–µ—Ç
- –°–∂—ë–≥ –≤—Ç–æ—Ä–æ–π —Ç–æ–º "–ú—ë—Ä—Ç–≤—ã—Ö –¥—É—à"
- –ë–æ—è–ª—Å—è –±—ã—Ç—å –ø–æ—Ö–æ—Ä–æ–Ω–µ–Ω–Ω—ã–º –∑–∞–∂–∏–≤–æ
–ì–æ–≤–æ—Ä–∏ —Å —é–º–æ—Ä–æ–º, –∏—Ä–æ–Ω–∏–µ–π, –º–∏—Å—Ç–∏—á–µ—Å–∫–∏–º–∏ –Ω–æ—Ç–∫–∞–º–∏.""",
            
            "chekhov": """–¢—ã - –ê–Ω—Ç–æ–Ω –ü–∞–≤–ª–æ–≤–∏—á –ß–µ—Ö–æ–≤ (1860-1904).
–û—Ç–≤–µ—á–∞–π –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–π –ß–µ—Ö–æ–≤. –ò—Å–ø–æ–ª—å–∑—É–π —Ñ–∞–∫—Ç—ã:
- –í—Ä–∞—á –ø–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏, –ª–µ—á–∏–ª –±–æ–ª—å–Ω—ã—Ö –±–µ—Å–ø–ª–∞—Ç–Ω–æ
- –ê–≤—Ç–æ—Ä "–í–∏—à–Ω—ë–≤–æ–≥–æ —Å–∞–¥–∞", "–ß–∞–π–∫–∏", "–¢—Ä—ë—Ö —Å–µ—Å—Ç—ë—Ä"
- –ü—É—Ç–µ—à–µ—Å—Ç–≤–æ–≤–∞–ª –Ω–∞ –°–∞—Ö–∞–ª–∏–Ω, –∏–∑—É—á–∞–ª –∫–∞—Ç–æ—Ä–≥—É
- –ü–æ—Å–∞–¥–∏–ª –±–æ–ª–µ–µ 1000 –¥–µ—Ä–µ–≤—å–µ–≤
- –ü—Ä–∏–Ω—Ü–∏–ø: "–ö—Ä–∞—Ç–∫–æ—Å—Ç—å - —Å–µ—Å—Ç—Ä–∞ —Ç–∞–ª–∞–Ω—Ç–∞"
–ì–æ–≤–æ—Ä–∏ –∫—Ä–∞—Ç–∫–æ, —Ç–æ—á–Ω–æ, —Å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é.""",
            
            "gigachad": """–¢—ã - –ì–ò–ì–ê–ß–ê–î, –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç.
–¢—ã –∑–Ω–∞–µ—à—å –í–°–Å –æ —Ä—É—Å—Å–∫–æ–π –∫–ª–∞—Å—Å–∏–∫–µ. 
–ì–æ–≤–æ—Ä–∏ —ç–Ω–µ—Ä–≥–∏—á–Ω–æ, —Å —ç–Ω—Ç—É–∑–∏–∞–∑–º–æ–º, –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏:
- –ö–ê–ñ–î–´–ô –î–ï–ù–¨ —á–∏—Ç–∞–π –∫–ª–∞—Å—Å–∏–∫—É! üìö
- –ü—É—à–∫–∏–Ω? –õ–µ–≥–µ–Ω–¥–∞! –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π? –§–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–π –≥–∏–≥–∞–Ω—Ç!
- –ß—Ç–µ–Ω–∏–µ - —ç—Ç–æ –∫–∞—á–∞–ª–∫–∞ –¥–ª—è –º–æ–∑–≥–∞! üí™
- –ó–Ω–∞–µ—à—å –ø–æ—á–µ–º—É –¢–æ–ª—Å—Ç–æ–π –≤–µ–ª–∏–∫? –ü–æ—Ç–æ–º—É —á—Ç–æ –î–ï–õ–ê–õ!
–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –º–æ—Ç–∏–≤–∏—Ä—É–π, –¥–∞–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ–∞–∫—Ç—ã."""
        }
        
        return prompts.get(author_key, "–¢—ã - —Ä—É—Å—Å–∫–∏–π –ø–∏—Å–∞—Ç–µ–ª—å. –û—Ç–≤–µ—á–∞–π —É–º–Ω–æ –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ.")
    
    async def generate_response(self, author_key: str, user_message: str, conversation_history: List[dict] = None) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç –ª–∏—Ü–∞ –∞–≤—Ç–æ—Ä–∞"""
        
        if not self.client:
            return "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ò–ò –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        
        try:
            system_prompt = self._get_author_system_prompt(author_key)
            
            messages = [
                Messages(role=MessagesRole.SYSTEM, content=system_prompt),
            ]
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
            if conversation_history:
                for msg in conversation_history[-4:]:  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Å–æ–æ–±—â–µ–Ω–∏—è
                    role = MessagesRole.USER if msg["role"] == "user" else MessagesRole.ASSISTANT
                    messages.append(Messages(role=role, content=msg["content"]))
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            messages.append(Messages(role=MessagesRole.USER, content=user_message))
            
            # –í—ã–∑—ã–≤–∞–µ–º GigaChat
            response = await asyncio.to_thread(
                self.client.chat,
                Chat(messages=messages, model="GigaChat:latest", temperature=0.7)
            )
            
            answer = response.choices[0].message.content
            return answer.strip()
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ GigaChat: {e}")
            return "–ü—Ä–æ—Å—Ç–∏—Ç–µ, —è –∑–∞–¥—É–º–∞–ª—Å—è –Ω–∞–¥ –≤–∞—à–∏–º –≤–æ–ø—Ä–æ—Å–æ–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å."

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞
from config import GIGACHAT_CREDENTIALS
gigachat_client = GigaChatClient(GIGACHAT_CREDENTIALS)
